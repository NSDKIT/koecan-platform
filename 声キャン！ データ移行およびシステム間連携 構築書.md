# å£°ã‚­ãƒ£ãƒ³ï¼ ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒãŠã‚ˆã³ã‚·ã‚¹ãƒ†ãƒ é–“é€£æº æ§‹ç¯‰æ›¸ v2.0

## æ”¹è¨‚å±¥æ­´
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|-----------|------|----------|--------|
| 1.0 | 2025-11-22 | åˆç‰ˆä½œæˆ | Claude |
| 2.0 | 2025-11-22 | v2.0æ©Ÿèƒ½è¿½åŠ ã€Supabaseãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ã€å®Ÿè£…çŠ¶æ³ã‚’åæ˜  | Claude |

## v2.0ã§ã®ä¸»ãªå¤‰æ›´ç‚¹
- âœ… Supabaseãƒ™ãƒ¼ã‚¹ã®æ§‹ç¯‰æ‰‹é †ã«å¤‰æ›´
- âœ… v2.0æ–°æ©Ÿèƒ½ï¼ˆå‹é”ç´¹ä»‹ã€FAQã€ãŠçŸ¥ã‚‰ã›ã€LINEé€£æºã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼‰ã®æ§‹ç¯‰æ‰‹é †ã‚’è¿½åŠ 
- âœ… ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªç”±å…¥åŠ›æ–¹å¼ã«å¤‰æ›´ï¼ˆå¤§å­¦ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç­‰ã‚’å‰Šé™¤ï¼‰
- âœ… RLSãƒãƒªã‚·ãƒ¼ã¨Database Functionsã®è¨­å®šæ‰‹é †ã‚’è¿½åŠ 
- âœ… å¤–éƒ¨APIé€£æºã®è‡ªå‹•åŒ–å®Ÿè£…ã‚’åæ˜ 
- âœ… Next.js/Vercelãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã«å¤‰æ›´
- âœ… LINE Messaging APIé€£æºã®æ§‹ç¯‰æ‰‹é †ã‚’è¿½åŠ 
- âœ… Firebase Cloud Messagingï¼ˆFCMï¼‰ã®æ§‹ç¯‰æ‰‹é †ã‚’è¿½åŠ 

---

## ç›®æ¬¡
1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¨ˆç”»](#2-ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¨ˆç”»)
3. [ã‚·ã‚¹ãƒ†ãƒ é–“é€£æºè¨­è¨ˆ](#3-ã‚·ã‚¹ãƒ†ãƒ é–“é€£æºè¨­è¨ˆ)
4. [å¤–éƒ¨APIé€£æº](#4-å¤–éƒ¨apié€£æº)
5. [ãƒ‡ãƒ¼ã‚¿åŒæœŸ](#5-ãƒ‡ãƒ¼ã‚¿åŒæœŸ)
6. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#6-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#7-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
8. [ç›£è¦–ã¨ãƒ­ã‚°](#8-ç›£è¦–ã¨ãƒ­ã‚°)
9. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#9-ãƒ†ã‚¹ãƒˆè¨ˆç”»)
10. [ç§»è¡Œå®Ÿæ–½æ‰‹é †](#10-ç§»è¡Œå®Ÿæ–½æ‰‹é †)

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„

æœ¬æ›¸ã¯ã€Œå£°ã‚­ãƒ£ãƒ³ï¼ã€ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹ä»¥ä¸‹ã®å†…å®¹ã‚’å®šç¾©ã—ã¾ã™ï¼š

1. **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ**
   - æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ–°ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
   - åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
   - ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™

2. **ã‚·ã‚¹ãƒ†ãƒ é–“é€£æº**
   - å¤–éƒ¨ãƒã‚¤ãƒ³ãƒˆäº¤æ›APIã¨ã®é€£æº
   - ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æº
   - ãã®ä»–å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æº
   - å°†æ¥çš„ãªæ‹¡å¼µã«å‚™ãˆãŸè¨­è¨ˆ

### 1.2 å¯¾è±¡ç¯„å›²

#### 1.2.1 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå¯¾è±¡ï¼ˆv2.0ï¼‰
- **FAQãƒ‡ãƒ¼ã‚¿**ï¼ˆåˆæœŸ50ä»¶ï¼‰
- **ãŠçŸ¥ã‚‰ã›ãƒ‡ãƒ¼ã‚¿**ï¼ˆåˆæœŸãƒ‡ãƒ¼ã‚¿ï¼‰
- **åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼**
- **äº¤æ›å¯èƒ½å•†å“ãƒã‚¹ã‚¿**ï¼ˆreward_itemsï¼‰
- **åˆæœŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿**ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ä¼æ¥­ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**

**æ³¨æ„**: v2.0ã§ã¯ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå¤§å­¦ã€å­¦éƒ¨ãƒ»å­¦ç§‘ã€éƒ½é“åºœçœŒç­‰ï¼‰ã¯è‡ªç”±å…¥åŠ›æ–¹å¼ã®ãŸã‚ã€äº‹å‰æº–å‚™ä¸è¦

#### 1.2.2 é€£æºå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ï¼ˆv2.0ï¼‰
- **å¤–éƒ¨ãƒã‚¤ãƒ³ãƒˆäº¤æ›ã‚µãƒ¼ãƒ“ã‚¹API**ï¼ˆPeXã€Gãƒã‚¤ãƒ³ãƒˆç­‰ï¼‰ğŸ†• è‡ªå‹•é€£æºå®Ÿè£…æ¸ˆã¿
- **LINE Messaging API** ğŸ†• é€šçŸ¥é€ä¿¡
- **ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹**ï¼ˆSendGrid/Resendï¼‰
- **ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹**ï¼ˆFirebase Cloud Messagingï¼‰ğŸ†•
- **ã‚¢ã‚¯ã‚»ã‚¹è§£æ**ï¼ˆGoogle Analytics 4ï¼‰
- **ã‚¨ãƒ©ãƒ¼ç›£è¦–**ï¼ˆSentryï¼‰
- **å°†æ¥çš„ãªé€£æºå€™è£œ**
  - æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹
  - SMSé€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹
  - CRMãƒ„ãƒ¼ãƒ«

### 1.3 å‰ææ¡ä»¶ï¼ˆv2.0ï¼‰

- æ–°ã‚·ã‚¹ãƒ†ãƒ ã¯å®Œå…¨ã«æ–°è¦æ§‹ç¯‰
- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆæ–°è¦ã‚µãƒ¼ãƒ“ã‚¹ï¼‰
- **Supabase**ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»èªè¨¼ãƒ»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦ä½¿ç”¨
- **Next.js 14**ï¼ˆApp Routerï¼‰ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹ç¯‰
- **Vercel**ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
- å¤–éƒ¨APIé€£æºã¯è‡ªå‹•åŒ–å®Ÿè£…æ¸ˆã¿ï¼ˆãƒã‚¤ãƒ³ãƒˆäº¤æ›APIï¼‰

---

## 2. SupabaseåˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 2.1 Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

#### 2.1.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ‰‹é †

1. **Supabaseã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**
   - https://supabase.com ã«ã‚¢ã‚¯ã‚»ã‚¹
   - GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰

2. **æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ**
   - ã€ŒNew Projectã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: `koekyan`ï¼ˆå£°ã‚­ãƒ£ãƒ³ï¼ï¼‰
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šï¼ˆä¿å­˜å¿…é ˆï¼‰
   - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: `Tokyo (ap-northeast-1)`ï¼ˆæ—¥æœ¬ï¼‰
   - ãƒ—ãƒ©ãƒ³: `Free`ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰ã¾ãŸã¯ `Pro`ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

3. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®ç¢ºèª**
   - Project URL: `https://xxxxx.supabase.co`
   - API Keyï¼ˆanon/publicï¼‰: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨
   - API Keyï¼ˆservice_roleï¼‰: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ï¼ˆæ©Ÿå¯†æƒ…å ±ï¼‰
   - Database Password: è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

#### 2.1.2 ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```bash
# .env.localï¼ˆNext.jsç”¨ï¼‰
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# .envï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ç”¨ã€æ©Ÿå¯†æƒ…å ±ï¼‰
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.xxxxx.supabase.co:5432/postgres
```

---

### 2.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

#### 2.2.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

Supabase Dashboardã®ã€ŒSQL Editorã€ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã€‚

**ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆSQL**:

```sql
-- UUIDæ‹¡å¼µæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆSupabase Authæ‹¡å¼µï¼‰
-- æ³¨æ„: auth.usersã¯SupabaseãŒè‡ªå‹•ç”Ÿæˆ

-- ãƒ¢ãƒ‹ã‚¿ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
CREATE TABLE monitor_profiles (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  age INTEGER,
  gender VARCHAR(20),
  occupation VARCHAR(100), -- è‡ªç”±å…¥åŠ›
  location VARCHAR(100), -- éƒ½é“åºœçœŒï¼ˆè‡ªç”±å…¥åŠ›ï¼‰
  points INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
CREATE TABLE client_profiles (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  company_name VARCHAR(255) NOT NULL,
  industry VARCHAR(100),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
CREATE TABLE surveys (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  client_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  points_reward INTEGER DEFAULT 0,
  target_conditions JSONB, -- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ¡ä»¶ï¼ˆå¹´é½¢ã€æ€§åˆ¥ç­‰ï¼‰
  is_published BOOLEAN DEFAULT false,
  published_at TIMESTAMPTZ,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè³ªå•
CREATE TABLE survey_questions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  survey_id UUID NOT NULL REFERENCES surveys(id) ON DELETE CASCADE,
  question_text TEXT NOT NULL,
  question_type VARCHAR(50) NOT NULL, -- 'single_choice', 'multiple_choice', 'text', 'number', 'rating'
  is_required BOOLEAN DEFAULT true,
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è³ªå•é¸æŠè‚¢
CREATE TABLE survey_question_options (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  question_id UUID NOT NULL REFERENCES survey_questions(id) ON DELETE CASCADE,
  option_text TEXT NOT NULL,
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”
CREATE TABLE survey_responses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  survey_id UUID NOT NULL REFERENCES surveys(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  submitted_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(survey_id, user_id) -- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1å›ç­”
);

-- å€‹åˆ¥å›ç­”
CREATE TABLE survey_answers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  response_id UUID NOT NULL REFERENCES survey_responses(id) ON DELETE CASCADE,
  question_id UUID NOT NULL REFERENCES survey_questions(id) ON DELETE CASCADE,
  answer_text TEXT,
  answer_number INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ãƒã‚¤ãƒ³ãƒˆå±¥æ­´
CREATE TABLE point_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  points INTEGER NOT NULL, -- æ­£ã®å€¤: ä»˜ä¸ã€è² ã®å€¤: ä½¿ç”¨
  source VARCHAR(100) NOT NULL, -- 'survey', 'referral', 'exchange', 'admin'
  reason TEXT,
  related_id UUID, -- é–¢é€£IDï¼ˆsurvey_id, referral_idç­‰ï¼‰
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ãƒã‚¤ãƒ³ãƒˆäº¤æ›ç”³è«‹
CREATE TABLE point_exchange_requests (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  reward_item_id UUID NOT NULL REFERENCES reward_items(id),
  points INTEGER NOT NULL,
  status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'processing', 'completed', 'rejected'
  exchange_id VARCHAR(255), -- å¤–éƒ¨APIã®äº¤æ›ID
  exchange_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ
);

-- äº¤æ›å¯èƒ½å•†å“ãƒã‚¹ã‚¿
CREATE TABLE reward_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
  description TEXT,
  points_required INTEGER NOT NULL,
  item_type VARCHAR(50), -- 'gift_card', 'cash', 'product'
  is_available BOOLEAN DEFAULT true,
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å‹é”ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ ğŸ†•
CREATE TABLE referral_codes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  code TEXT UNIQUE NOT NULL, -- 'KOECAN-XXXXXXXX'å½¢å¼
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id) -- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1ã‚³ãƒ¼ãƒ‰
);

-- å‹é”ç´¹ä»‹å±¥æ­´ ğŸ†•
CREATE TABLE referral_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  referrer_user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  referred_user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  referral_code_id UUID NOT NULL REFERENCES referral_codes(id),
  referrer_reward_points INTEGER DEFAULT 200,
  referred_reward_points INTEGER DEFAULT 100,
  status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'completed', 'rejected'
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ
);

-- FAQ ğŸ†•
CREATE TABLE faqs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  category VARCHAR(100) NOT NULL, -- 'account', 'survey', 'point', 'referral', 'other'
  question TEXT NOT NULL,
  answer TEXT NOT NULL, -- Markdownå¯¾å¿œ
  display_order INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  is_published BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ãŠçŸ¥ã‚‰ã› ğŸ†•
CREATE TABLE announcements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(255) NOT NULL,
  content TEXT NOT NULL, -- Markdownå¯¾å¿œ
  announcement_type VARCHAR(50) NOT NULL, -- 'maintenance', 'news', 'campaign', 'important'
  target_roles TEXT[] DEFAULT ARRAY['monitor', 'client'], -- å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
  priority VARCHAR(20) DEFAULT 'normal', -- 'low', 'normal', 'high'
  is_published BOOLEAN DEFAULT false,
  publish_start_at TIMESTAMPTZ,
  publish_end_at TIMESTAMPTZ,
  send_push_notification BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- LINEé€£æºæƒ…å ± ğŸ†•
CREATE TABLE line_connections (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  line_user_id VARCHAR(255) NOT NULL UNIQUE,
  connected_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);

-- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è³¼èª­æƒ…å ± ğŸ†•
CREATE TABLE push_subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL,
  p256dh TEXT NOT NULL,
  auth TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, endpoint)
);

-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ğŸ†•
CREATE TABLE chat_messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  message TEXT NOT NULL,
  is_from_user BOOLEAN DEFAULT true, -- true: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€false: ã‚µãƒãƒ¼ãƒˆ
  support_user_id UUID REFERENCES auth.users(id), -- ã‚µãƒãƒ¼ãƒˆæ‹…å½“è€…ID
  is_read BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_surveys_client_id ON surveys(client_id);
CREATE INDEX idx_surveys_published ON surveys(is_published, published_at);
CREATE INDEX idx_survey_questions_survey_id ON survey_questions(survey_id);
CREATE INDEX idx_survey_responses_survey_id ON survey_responses(survey_id);
CREATE INDEX idx_survey_responses_user_id ON survey_responses(user_id);
CREATE INDEX idx_point_history_user_id ON point_history(user_id);
CREATE INDEX idx_point_history_created_at ON point_history(created_at);
CREATE INDEX idx_referral_codes_code ON referral_codes(code);
CREATE INDEX idx_referral_history_referrer ON referral_history(referrer_user_id);
CREATE INDEX idx_faqs_category ON faqs(category, is_published);
CREATE INDEX idx_announcements_published ON announcements(is_published, publish_start_at);
```

---

## 3. Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼è¨­å®š

### 3.1 RLSæœ‰åŠ¹åŒ–

å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSã‚’æœ‰åŠ¹åŒ–ï¼ˆSupabaseæ¨™æº–ã§ã¯ç„¡åŠ¹ï¼‰ã€‚

```sql
-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE monitor_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE client_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE surveys ENABLE ROW LEVEL SECURITY;
ALTER TABLE survey_questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE survey_question_options ENABLE ROW LEVEL SECURITY;
ALTER TABLE survey_responses ENABLE ROW LEVEL SECURITY;
ALTER TABLE survey_answers ENABLE ROW LEVEL SECURITY;
ALTER TABLE point_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE point_exchange_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE reward_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE referral_codes ENABLE ROW LEVEL SECURITY;
ALTER TABLE referral_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE faqs ENABLE ROW LEVEL SECURITY;
ALTER TABLE announcements ENABLE ROW LEVEL SECURITY;
ALTER TABLE line_connections ENABLE ROW LEVEL SECURITY;
ALTER TABLE push_subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;
```

### 3.2 ä¸»è¦RLSãƒãƒªã‚·ãƒ¼

#### 3.2.1 monitor_profiles

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿å‚ç…§ãƒ»æ›´æ–°å¯èƒ½
CREATE POLICY "Users can view own profile"
ON monitor_profiles FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can update own profile"
ON monitor_profiles FOR UPDATE
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own profile"
ON monitor_profiles FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

#### 3.2.2 surveys

```sql
-- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å…¬é–‹æ¸ˆã¿ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’å‚ç…§å¯èƒ½
CREATE POLICY "Anyone can view published surveys"
ON surveys FOR SELECT
USING (is_published = true AND (expires_at IS NULL OR expires_at > NOW()));

-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è‡ªç¤¾ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç®¡ç†å¯èƒ½
CREATE POLICY "Clients can manage own surveys"
ON surveys FOR ALL
USING (
  auth.uid() = client_id AND
  EXISTS (SELECT 1 FROM auth.users WHERE id = auth.uid() AND raw_user_meta_data->>'role' = 'client')
);

-- ç®¡ç†è€…ã¯å…¨ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç®¡ç†å¯èƒ½
CREATE POLICY "Admins can manage all surveys"
ON surveys FOR ALL
USING (
  EXISTS (SELECT 1 FROM auth.users WHERE id = auth.uid() AND raw_user_meta_data->>'role' = 'admin')
);
```

#### 3.2.3 survey_responses

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®å›ç­”ã®ã¿æŒ¿å…¥å¯èƒ½
CREATE POLICY "Users can insert own responses"
ON survey_responses FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®å›ç­”ã®ã¿å‚ç…§å¯èƒ½
CREATE POLICY "Users can view own responses"
ON survey_responses FOR SELECT
USING (auth.uid() = user_id);

-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è‡ªç¤¾ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®å›ç­”ã®ã¿å‚ç…§å¯èƒ½
CREATE POLICY "Clients can view own survey responses"
ON survey_responses FOR SELECT
USING (
  survey_id IN (
    SELECT id FROM surveys WHERE client_id = auth.uid()
  )
);

-- ç®¡ç†è€…ã¯å…¨å›ç­”ã‚’å‚ç…§å¯èƒ½
CREATE POLICY "Admins can view all responses"
ON survey_responses FOR SELECT
USING (
  EXISTS (SELECT 1 FROM auth.users WHERE id = auth.uid() AND raw_user_meta_data->>'role' = 'admin')
);
```

#### 3.2.4 point_history

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã®ã¿å‚ç…§å¯èƒ½
CREATE POLICY "Users can view own point history"
ON point_history FOR SELECT
USING (auth.uid() = user_id);

-- æŒ¿å…¥ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢æ•°ã®ã¿ï¼ˆRPCçµŒç”±ï¼‰
CREATE POLICY "Only backend can insert points"
ON point_history FOR INSERT
WITH CHECK (false); -- ç›´æ¥æŒ¿å…¥ã¯ç¦æ­¢ã€RPCçµŒç”±ã®ã¿
```

#### 3.2.5 referral_codes

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã®ã¿å‚ç…§å¯èƒ½
CREATE POLICY "Users can view own referral code"
ON referral_codes FOR SELECT
USING (auth.uid() = user_id);

-- æŒ¿å…¥ã‚‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢æ•°çµŒç”±
CREATE POLICY "Only backend can create referral codes"
ON referral_codes FOR INSERT
WITH CHECK (false);
```

#### 3.2.6 faqs

```sql
-- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å…¬é–‹æ¸ˆã¿FAQã‚’å‚ç…§å¯èƒ½
CREATE POLICY "Anyone can view published FAQs"
ON faqs FOR SELECT
USING (is_published = true);

-- ç®¡ç†è€…ã®ã¿ç®¡ç†å¯èƒ½
CREATE POLICY "Admins can manage FAQs"
ON faqs FOR ALL
USING (
  EXISTS (SELECT 1 FROM auth.users WHERE id = auth.uid() AND raw_user_meta_data->>'role' = 'admin')
);
```

#### 3.2.7 announcements

```sql
-- å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å…¬é–‹æ¸ˆã¿ãŠçŸ¥ã‚‰ã›ã‚’å‚ç…§å¯èƒ½
CREATE POLICY "Users can view published announcements"
ON announcements FOR SELECT
USING (
  is_published = true AND
  (publish_start_at IS NULL OR publish_start_at <= NOW()) AND
  (publish_end_at IS NULL OR publish_end_at >= NOW()) AND
  (
    'monitor' = ANY(target_roles) OR
    'client' = ANY(target_roles) OR
    EXISTS (SELECT 1 FROM auth.users WHERE id = auth.uid() AND raw_user_meta_data->>'role' = 'admin')
  )
);

-- ç®¡ç†è€…ã®ã¿ç®¡ç†å¯èƒ½
CREATE POLICY "Admins can manage announcements"
ON announcements FOR ALL
USING (
  EXISTS (SELECT 1 FROM auth.users WHERE id = auth.uid() AND raw_user_meta_data->>'role' = 'admin')
);
```

---

## 4. Database Functions (RPC) ä½œæˆ

### 4.1 ãƒã‚¤ãƒ³ãƒˆä»˜ä¸é–¢æ•°

```sql
-- ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ï¼ˆRPCï¼‰
CREATE OR REPLACE FUNCTION add_points(
  p_user_id UUID,
  p_points INTEGER,
  p_source VARCHAR(100),
  p_reference_id UUID DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER -- ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œ
AS $$
DECLARE
  v_point_history_id UUID;
BEGIN
  -- ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã«è¨˜éŒ²
  INSERT INTO point_history (user_id, points, source, related_id)
  VALUES (p_user_id, p_points, p_source, p_reference_id)
  RETURNING id INTO v_point_history_id;
  
  -- ãƒ¢ãƒ‹ã‚¿ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°
  UPDATE monitor_profiles
  SET points = points + p_points,
      updated_at = NOW()
  WHERE user_id = p_user_id;
  
  RETURN v_point_history_id;
END;
$$;
```

### 4.2 ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç™ºè¡Œé–¢æ•° ğŸ†•

```sql
-- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç™ºè¡Œï¼ˆRPCï¼‰
CREATE OR REPLACE FUNCTION generate_referral_code(
  p_user_id UUID
)
RETURNS TEXT
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_code TEXT;
  v_exists BOOLEAN;
BEGIN
  -- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ç¢ºèª
  SELECT EXISTS(SELECT 1 FROM referral_codes WHERE user_id = p_user_id) INTO v_exists;
  
  IF v_exists THEN
    -- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
    SELECT code INTO v_code FROM referral_codes WHERE user_id = p_user_id;
    RETURN v_code;
  END IF;
  
  -- æ–°è¦ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆKOECAN-XXXXXXXXå½¢å¼ï¼‰
  LOOP
    v_code := 'KOECAN-' || upper(substring(md5(random()::text || clock_timestamp()::text) from 1 for 8));
    
    -- é‡è¤‡ãƒã‚§ãƒƒã‚¯
    SELECT EXISTS(SELECT 1 FROM referral_codes WHERE code = v_code) INTO v_exists;
    
    EXIT WHEN NOT v_exists;
  END LOOP;
  
  -- ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
  INSERT INTO referral_codes (user_id, code)
  VALUES (p_user_id, v_code);
  
  RETURN v_code;
END;
$$;
```

### 4.3 ç´¹ä»‹å®Œäº†å‡¦ç†é–¢æ•° ğŸ†•

```sql
-- ç´¹ä»‹å®Œäº†å‡¦ç†ï¼ˆRPCï¼‰
CREATE OR REPLACE FUNCTION complete_referral(
  p_referral_code TEXT,
  p_referred_user_id UUID
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_referral_code_id UUID;
  v_referrer_user_id UUID;
  v_referral_history_id UUID;
BEGIN
  -- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç¢ºèª
  SELECT id, user_id INTO v_referral_code_id, v_referrer_user_id
  FROM referral_codes
  WHERE code = p_referral_code;
  
  IF v_referral_code_id IS NULL THEN
    RAISE EXCEPTION 'Invalid referral code';
  END IF;
  
  -- è‡ªå·±ç´¹ä»‹é˜²æ­¢
  IF v_referrer_user_id = p_referred_user_id THEN
    RAISE EXCEPTION 'Cannot refer yourself';
  END IF;
  
  -- ç´¹ä»‹å±¥æ­´ä½œæˆ
  INSERT INTO referral_history (
    referrer_user_id,
    referred_user_id,
    referral_code_id,
    status
  )
  VALUES (
    v_referrer_user_id,
    p_referred_user_id,
    v_referral_code_id,
    'pending'
  )
  RETURNING id INTO v_referral_history_id;
  
  RETURN v_referral_history_id;
END;
$$;
```

### 4.4 ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”å‡¦ç†é–¢æ•°

```sql
-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”å‡¦ç†ï¼ˆRPCï¼‰
CREATE OR REPLACE FUNCTION submit_survey_response(
  p_survey_id UUID,
  p_user_id UUID,
  p_answers JSONB
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_response_id UUID;
  v_survey_points INTEGER;
  v_answer_item JSONB;
BEGIN
  -- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ãƒã‚¤ãƒ³ãƒˆå ±é…¬ã‚’å–å¾—
  SELECT points_reward INTO v_survey_points
  FROM surveys
  WHERE id = p_survey_id AND is_published = true;
  
  IF v_survey_points IS NULL THEN
    RAISE EXCEPTION 'Survey not found or not published';
  END IF;
  
  -- å›ç­”è¨˜éŒ²
  INSERT INTO survey_responses (survey_id, user_id)
  VALUES (p_survey_id, p_user_id)
  RETURNING id INTO v_response_id;
  
  -- å€‹åˆ¥å›ç­”ã‚’è¨˜éŒ²
  FOR v_answer_item IN SELECT * FROM jsonb_array_elements(p_answers)
  LOOP
    INSERT INTO survey_answers (response_id, question_id, answer_text, answer_number)
    VALUES (
      v_response_id,
      (v_answer_item->>'question_id')::UUID,
      v_answer_item->>'answer_text',
      (v_answer_item->>'answer_number')::INTEGER
    );
  END LOOP;
  
  -- ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
  PERFORM add_points(p_user_id, v_survey_points, 'survey', p_survey_id);
  
  RETURN v_response_id;
END;
$$;
```

---

## 5. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¨ˆç”»ï¼ˆv2.0ï¼‰

### 5.1 ç§»è¡Œå¯¾è±¡ãƒ‡ãƒ¼ã‚¿

#### 5.1.1 åˆæœŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‡ãƒ¼ã‚¿

**FAQ ãƒ‡ãƒ¼ã‚¿**ï¼ˆ50ä»¶ï¼‰

**ã‚«ãƒ†ã‚´ãƒª**:
- `account` - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ç™»éŒ²ï¼ˆ10ä»¶ï¼‰
- `survey` - ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆ15ä»¶ï¼‰
- `point` - ãƒã‚¤ãƒ³ãƒˆï¼ˆ15ä»¶ï¼‰
- `referral` - å‹é”ç´¹ä»‹ï¼ˆ5ä»¶ï¼‰
- `other` - ãã®ä»–ï¼ˆ5ä»¶ï¼‰

**ãƒ‡ãƒ¼ã‚¿æŠ•å…¥æ–¹æ³•**: Supabase Dashboardã®ã€ŒTable Editorã€ã‹ã‚‰æ‰‹å‹•æŠ•å…¥ã€ã¾ãŸã¯SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

**ã‚µãƒ³ãƒ—ãƒ«FAQãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰**:
```json
[
  {
    "category": "account",
    "question": "ä¼šå“¡ç™»éŒ²ã¯ã©ã®ã‚ˆã†ã«è¡Œã„ã¾ã™ã‹ï¼Ÿ",
    "answer": "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ã€Œæ–°è¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™ã€‚ç™»éŒ²å¾Œã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™ã®ã§ã€ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚",
    "display_order": 1,
    "is_published": true
  },
  {
    "category": "account",
    "question": "ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“",
    "answer": "ä»¥ä¸‹ã®ç‚¹ã‚’ã”ç¢ºèªãã ã•ã„ï¼š\n1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹\n2. ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹\n3. Caps LockãŒã‚ªãƒ³ã«ãªã£ã¦ã„ãªã„ã‹\n\nãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆã¯ã€ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã€ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’è©¦ã—ã¦ãã ã•ã„ã€‚",
    "display_order": 2,
    "is_published": true
  }
]
```

**FAQãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆTypeScript/Node.jsï¼‰**:
```typescript
// scripts/import_faqs.ts
import { createClient } from '@supabase/supabase-js';
import faqsData from './data/faqs.json';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function importFAQs() {
  for (const faq of faqsData) {
    const { error } = await supabase
      .from('faqs')
      .insert({
        category: faq.category,
        question: faq.question,
        answer: faq.answer,
        display_order: faq.display_order,
        is_published: faq.is_published
      });
    
    if (error) {
      console.error(`Failed to import FAQ: ${faq.question}`, error);
    } else {
      console.log(`âœ“ Imported: ${faq.question}`);
    }
  }
}

importFAQs();
```

---

**ãŠçŸ¥ã‚‰ã›ãƒ‡ãƒ¼ã‚¿**ï¼ˆåˆæœŸãƒ‡ãƒ¼ã‚¿ï¼‰

**ãŠçŸ¥ã‚‰ã›ã‚¿ã‚¤ãƒ—**:
- `maintenance` - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
- `news` - ãŠçŸ¥ã‚‰ã›
- `campaign` - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³
- `important` - é‡è¦ãªãŠçŸ¥ã‚‰ã›

**ã‚µãƒ³ãƒ—ãƒ«ãŠçŸ¥ã‚‰ã›ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰**:
```json
[
  {
    "title": "ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹ã®ãŠçŸ¥ã‚‰ã›",
    "content": "å£°ã‚­ãƒ£ãƒ³ï¼ã‚’ã”åˆ©ç”¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\næœ¬æ—¥ã‚ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ã„ãŸã—ã¾ã—ãŸã€‚",
    "announcement_type": "news",
    "target_roles": ["monitor", "client"],
    "priority": "high",
    "is_published": true,
    "publish_start_at": "2025-11-22T00:00:00Z"
  }
]
```

---

**äº¤æ›å¯èƒ½å•†å“ãƒã‚¹ã‚¿**ï¼ˆreward_itemsï¼‰

**åˆæœŸå•†å“ä¾‹**:
- Amazonã‚®ãƒ•ãƒˆåˆ¸ 500å††åˆ†ï¼ˆ500ptï¼‰
- Amazonã‚®ãƒ•ãƒˆåˆ¸ 1,000å††åˆ†ï¼ˆ1,000ptï¼‰
- ç¾é‡‘ 500å††ï¼ˆ500ptï¼‰
- ç¾é‡‘ 1,000å††ï¼ˆ1,000ptï¼‰

**ãƒ‡ãƒ¼ã‚¿æŠ•å…¥æ–¹æ³•**: Supabase Dashboardã‹ã‚‰æ‰‹å‹•æŠ•å…¥ã€ã¾ãŸã¯SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

**ã‚µãƒ³ãƒ—ãƒ«å•†å“ãƒ‡ãƒ¼ã‚¿ï¼ˆSQLï¼‰**:
```sql
INSERT INTO reward_items (name, description, points_required, item_type, is_available, display_order)
VALUES
  ('Amazonã‚®ãƒ•ãƒˆåˆ¸ 500å††åˆ†', 'Amazonã‚®ãƒ•ãƒˆåˆ¸ã‚’500å††åˆ†ãŠé€ã‚Šã—ã¾ã™', 500, 'gift_card', true, 1),
  ('Amazonã‚®ãƒ•ãƒˆåˆ¸ 1,000å††åˆ†', 'Amazonã‚®ãƒ•ãƒˆåˆ¸ã‚’1,000å††åˆ†ãŠé€ã‚Šã—ã¾ã™', 1000, 'gift_card', true, 2),
  ('ç¾é‡‘ 500å††', 'éŠ€è¡ŒæŒ¯è¾¼ã§500å††ã‚’ãŠé€ã‚Šã—ã¾ã™', 500, 'cash', true, 3),
  ('ç¾é‡‘ 1,000å††', 'éŠ€è¡ŒæŒ¯è¾¼ã§1,000å††ã‚’ãŠé€ã‚Šã—ã¾ã™', 1000, 'cash', true, 4);
```

**ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿**:
```csv
id,name,region
1,åŒ—æµ·é“,åŒ—æµ·é“
2,é’æ£®çœŒ,æ±åŒ—
3,å²©æ‰‹çœŒ,æ±åŒ—
...
13,æ±äº¬éƒ½,é–¢æ±
...
```

---

**å­¦å¹´ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿**
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«: grade_levels
CREATE TABLE grade_levels (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    display_order INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿**:
```csv
id,name,display_order
1,å­¦éƒ¨1å¹´,1
2,å­¦éƒ¨2å¹´,2
3,å­¦éƒ¨3å¹´,3
4,å­¦éƒ¨4å¹´,4
5,ä¿®å£«1å¹´,5
6,ä¿®å£«2å¹´,6
7,åšå£«1å¹´,7
8,åšå£«2å¹´,8
9,åšå£«3å¹´ä»¥ä¸Š,9
```

---

#### 2.1.2 åˆæœŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‡ãƒ¼ã‚¿

**FAQ ãƒ‡ãƒ¼ã‚¿**
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«: faqs
CREATE TABLE faqs (
    id SERIAL PRIMARY KEY,
    category VARCHAR(100) NOT NULL,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    display_order INT,
    is_published BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ãƒ‡ãƒ¼ã‚¿ä»¶æ•°**: 50ä»¶ï¼ˆåˆæœŸï¼‰

**ã‚«ãƒ†ã‚´ãƒª**:
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ç™»éŒ²
- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
- ãƒã‚¤ãƒ³ãƒˆ
- å‹é”ç´¹ä»‹
- ãã®ä»–

---

**åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼**
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«: legal_documents
CREATE TABLE legal_documents (
    id SERIAL PRIMARY KEY,
    type VARCHAR(50) NOT NULL, -- terms/privacy
    version VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    effective_date DATE NOT NULL,
    is_current BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

**ãŠçŸ¥ã‚‰ã›ãƒ‡ãƒ¼ã‚¿**
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«: announcements
CREATE TABLE announcements (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    announcement_type VARCHAR(50), -- news/maintenance/campaign
    priority INT DEFAULT 0,
    publish_start_at TIMESTAMP,
    publish_end_at TIMESTAMP,
    is_published BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

#### 2.1.3 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

**ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼**
- ä»¶æ•°: 20ä»¶
- ç”¨é€”: å‹•ä½œç¢ºèªã€ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**ãƒ†ã‚¹ãƒˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ**
- ä»¶æ•°: 10ä»¶
- å„ç¨®è³ªå•ã‚¿ã‚¤ãƒ—ã‚’å«ã‚€

**ãƒ†ã‚¹ãƒˆä¼æ¥­ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**
- ä»¶æ•°: 3ä»¶
- ç”¨é€”: ä¼æ¥­æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

---

### 2.2 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ–¹å¼

#### 2.2.1 ç§»è¡Œæ–¹å¼ã®é¸æŠ

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ç§»è¡Œæ–¹å¼ | ç†ç”± |
|------------|----------|------|
| ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ | CSVãƒãƒ«ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆ | å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬æŠ•å…¥ |
| åˆæœŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ | SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ | æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ |
| ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ | Seederã‚¹ã‚¯ãƒªãƒ—ãƒˆ | é–‹ç™ºç’°å¢ƒã§ã®å†ç¾æ€§ |

#### 2.2.2 ç§»è¡Œãƒ„ãƒ¼ãƒ«

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ•å…¥ãƒ„ãƒ¼ãƒ«**
```
é¸æŠè‚¢1: ã‚«ã‚¹ã‚¿ãƒ Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€ pandas ã§CSVèª­ã¿è¾¼ã¿
â”œâ”€ SQLAlchemy ã§DBæ¥ç¶š
â””â”€ ãƒãƒƒãƒå‡¦ç†ã§é«˜é€ŸæŠ•å…¥

é¸æŠè‚¢2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ„ãƒ¼ãƒ«
â”œâ”€ PostgreSQL: COPY ã‚³ãƒãƒ³ãƒ‰
â”œâ”€ MySQL: LOAD DATA INFILE
â””â”€ æœ€é€Ÿã ãŒæŸ”è»Ÿæ€§ã¯ä½ã„

é¸æŠè‚¢3: ORMã®Seederæ©Ÿèƒ½
â”œâ”€ Django: loaddata
â”œâ”€ Rails: db:seed
â””â”€ é–‹ç™ºç’°å¢ƒã¨ã®ä¸€è²«æ€§
```

**æ¨å¥¨**: Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ + ORMã®Seederä½µç”¨

---

### 2.3 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### 2.3.1 å¤§å­¦ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# scripts/import_universities.py
import pandas as pd
from sqlalchemy import create_engine
from datetime import datetime

def import_universities(csv_file, db_url):
    """
    å¤§å­¦ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    
    Args:
        csv_file: CSVãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        db_url: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURL
    """
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
    engine = create_engine(db_url)
    
    # CSVèª­ã¿è¾¼ã¿
    df = pd.read_csv(csv_file, encoding='utf-8')
    
    # ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
    required_columns = ['name', 'name_kana', 'prefecture_id', 'category']
    if not all(col in df.columns for col in required_columns):
        raise ValueError(f"å¿…é ˆã‚«ãƒ©ãƒ ãŒä¸è¶³ã—ã¦ã„ã¾ã™: {required_columns}")
    
    # NULLå€¤ãƒã‚§ãƒƒã‚¯
    if df[required_columns].isnull().any().any():
        raise ValueError("NULLå€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™")
    
    # ã‚«ãƒ†ã‚´ãƒªå€¤ã®æ¤œè¨¼
    valid_categories = ['å›½ç«‹', 'å…¬ç«‹', 'ç§ç«‹']
    if not df['category'].isin(valid_categories).all():
        raise ValueError(f"ä¸æ­£ãªã‚«ãƒ†ã‚´ãƒªå€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™: {valid_categories}")
    
    # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
    df['created_at'] = datetime.now()
    df['updated_at'] = datetime.now()
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŠ•å…¥
    try:
        # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
        with engine.begin() as connection:
            # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆåˆæœŸæŠ•å…¥æ™‚ã®ã¿ï¼‰
            connection.execute("TRUNCATE TABLE universities RESTART IDENTITY CASCADE")
            
            # ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
            df.to_sql('universities', connection, if_exists='append', index=False)
            
            print(f"âœ“ {len(df)}ä»¶ã®å¤§å­¦ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã—ãŸ")
            
    except Exception as e:
        print(f"âœ— ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        raise

if __name__ == '__main__':
    import sys
    
    if len(sys.argv) != 3:
        print("ä½¿ã„æ–¹: python import_universities.py <CSV_FILE> <DB_URL>")
        sys.exit(1)
    
    csv_file = sys.argv[1]
    db_url = sys.argv[2]
    
    import_universities(csv_file, db_url)
```

**å®Ÿè¡Œä¾‹**:
```bash
python scripts/import_universities.py \
  data/universities.csv \
  "postgresql://user:pass@localhost:5432/koekyan"
```

---

#### 2.3.2 FAQ ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# scripts/import_faqs.py
import json
from sqlalchemy import create_engine, text
from datetime import datetime

def import_faqs(json_file, db_url):
    """
    FAQãƒ‡ãƒ¼ã‚¿ã‚’JSONã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    
    Args:
        json_file: JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        db_url: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURL
    """
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
    engine = create_engine(db_url)
    
    # JSONèª­ã¿è¾¼ã¿
    with open(json_file, 'r', encoding='utf-8') as f:
        faqs = json.load(f)
    
    # ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
    for faq in faqs:
        required_fields = ['category', 'question', 'answer', 'display_order']
        if not all(field in faq for field in required_fields):
            raise ValueError(f"å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³: {faq}")
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŠ•å…¥
    try:
        with engine.begin() as connection:
            # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
            connection.execute(text("TRUNCATE TABLE faqs RESTART IDENTITY CASCADE"))
            
            # 1ä»¶ãšã¤æŠ•å…¥
            for faq in faqs:
                query = text("""
                    INSERT INTO faqs 
                    (category, question, answer, display_order, is_published, created_at, updated_at)
                    VALUES 
                    (:category, :question, :answer, :display_order, :is_published, :created_at, :updated_at)
                """)
                
                connection.execute(query, {
                    'category': faq['category'],
                    'question': faq['question'],
                    'answer': faq['answer'],
                    'display_order': faq['display_order'],
                    'is_published': faq.get('is_published', True),
                    'created_at': datetime.now(),
                    'updated_at': datetime.now()
                })
            
            print(f"âœ“ {len(faqs)}ä»¶ã®FAQãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã—ãŸ")
            
    except Exception as e:
        print(f"âœ— ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        raise

if __name__ == '__main__':
    import sys
    
    if len(sys.argv) != 3:
        print("ä½¿ã„æ–¹: python import_faqs.py <JSON_FILE> <DB_URL>")
        sys.exit(1)
    
    json_file = sys.argv[1]
    db_url = sys.argv[2]
    
    import_faqs(json_file, db_url)
```

**FAQãƒ‡ãƒ¼ã‚¿å½¢å¼ï¼ˆJSONï¼‰**:
```json
[
  {
    "category": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ç™»éŒ²",
    "question": "ä¼šå“¡ç™»éŒ²ã¯ã©ã®ã‚ˆã†ã«è¡Œã„ã¾ã™ã‹ï¼Ÿ",
    "answer": "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ã€Œæ–°è¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™ã€‚ç™»éŒ²å¾Œã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™ã®ã§ã€ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚",
    "display_order": 1,
    "is_published": true
  },
  {
    "category": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ç™»éŒ²",
    "question": "ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“",
    "answer": "ä»¥ä¸‹ã®ç‚¹ã‚’ã”ç¢ºèªãã ã•ã„ï¼š\n1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹\n2. ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹\n3. Caps LockãŒã‚ªãƒ³ã«ãªã£ã¦ã„ãªã„ã‹\n\nãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆã¯ã€ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã€ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’è©¦ã—ã¦ãã ã•ã„ã€‚",
    "display_order": 2,
    "is_published": true
  }
]
```

---

#### 2.3.3 ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æŠ•å…¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# scripts/import_all_masters.py
import os
from import_universities import import_universities
from import_faculties import import_faculties
from import_departments import import_departments
from import_prefectures import import_prefectures
from import_grade_levels import import_grade_levels
from import_faqs import import_faqs

def import_all_masters(data_dir, db_url):
    """
    ã™ã¹ã¦ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æŠ•å…¥
    
    Args:
        data_dir: ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        db_url: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURL
    """
    print("=" * 60)
    print("ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æŠ•å…¥é–‹å§‹")
    print("=" * 60)
    
    # æŠ•å…¥é †åºï¼ˆå¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è€ƒæ…®ï¼‰
    imports = [
        ('éƒ½é“åºœçœŒ', 'prefectures.csv', import_prefectures),
        ('å¤§å­¦', 'universities.csv', import_universities),
        ('å­¦å¹´', 'grade_levels.csv', import_grade_levels),
        ('å­¦éƒ¨', 'faculties.csv', import_faculties),
        ('å­¦ç§‘', 'departments.csv', import_departments),
        ('FAQ', 'faqs.json', import_faqs),
    ]
    
    success_count = 0
    fail_count = 0
    
    for name, filename, import_func in imports:
        filepath = os.path.join(data_dir, filename)
        
        print(f"\n[{name}] æŠ•å…¥ä¸­...")
        try:
            import_func(filepath, db_url)
            success_count += 1
            print(f"[{name}] âœ“ å®Œäº†")
        except Exception as e:
            fail_count += 1
            print(f"[{name}] âœ— å¤±æ•—: {e}")
    
    print("\n" + "=" * 60)
    print(f"æŠ•å…¥å®Œäº†: æˆåŠŸ {success_count}ä»¶ / å¤±æ•— {fail_count}ä»¶")
    print("=" * 60)
    
    return fail_count == 0

if __name__ == '__main__':
    import sys
    
    if len(sys.argv) != 3:
        print("ä½¿ã„æ–¹: python import_all_masters.py <DATA_DIR> <DB_URL>")
        sys.exit(1)
    
    data_dir = sys.argv[1]
    db_url = sys.argv[2]
    
    success = import_all_masters(data_dir, db_url)
    sys.exit(0 if success else 1)
```

**å®Ÿè¡Œä¾‹**:
```bash
python scripts/import_all_masters.py \
  data/masters \
  "postgresql://user:pass@localhost:5432/koekyan"
```

---

### 2.4 ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

#### 2.4.1 æŠ•å…¥å¾Œæ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# scripts/validate_data.py
from sqlalchemy import create_engine, text

def validate_data(db_url):
    """
    æŠ•å…¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
    
    Args:
        db_url: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURL
    
    Returns:
        bool: æ¤œè¨¼æˆåŠŸ/å¤±æ•—
    """
    engine = create_engine(db_url)
    
    validations = []
    
    with engine.connect() as connection:
        # 1. ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãƒã‚§ãƒƒã‚¯
        print("\n[ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãƒã‚§ãƒƒã‚¯]")
        tables_expected = {
            'prefectures': 47,
            'universities': (700, 900),  # ç¯„å›²æŒ‡å®š
            'grade_levels': 9,
            'faculties': (40, 60),
            'departments': (150, 250),
            'faqs': (30, 100),
        }
        
        for table, expected in tables_expected.items():
            result = connection.execute(text(f"SELECT COUNT(*) FROM {table}"))
            actual = result.scalar()
            
            if isinstance(expected, tuple):
                min_val, max_val = expected
                is_valid = min_val <= actual <= max_val
                expected_str = f"{min_val}ã€œ{max_val}"
            else:
                is_valid = actual == expected
                expected_str = str(expected)
            
            status = "âœ“" if is_valid else "âœ—"
            print(f"  {status} {table}: {actual}ä»¶ (æœŸå¾…å€¤: {expected_str})")
            validations.append(is_valid)
        
        # 2. NULLå€¤ãƒã‚§ãƒƒã‚¯
        print("\n[NULLå€¤ãƒã‚§ãƒƒã‚¯]")
        null_checks = [
            ("universities", "name"),
            ("universities", "category"),
            ("faculties", "name"),
            ("prefectures", "name"),
        ]
        
        for table, column in null_checks:
            result = connection.execute(
                text(f"SELECT COUNT(*) FROM {table} WHERE {column} IS NULL")
            )
            null_count = result.scalar()
            
            is_valid = null_count == 0
            status = "âœ“" if is_valid else "âœ—"
            print(f"  {status} {table}.{column}: NULLå€¤ {null_count}ä»¶")
            validations.append(is_valid)
        
        # 3. å¤–éƒ¨ã‚­ãƒ¼æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        print("\n[å¤–éƒ¨ã‚­ãƒ¼æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯]")
        fk_checks = [
            ("universities", "prefecture_id", "prefectures", "id"),
            ("departments", "faculty_id", "faculties", "id"),
        ]
        
        for child_table, child_col, parent_table, parent_col in fk_checks:
            result = connection.execute(text(f"""
                SELECT COUNT(*) 
                FROM {child_table} c
                LEFT JOIN {parent_table} p ON c.{child_col} = p.{parent_col}
                WHERE p.{parent_col} IS NULL
            """))
            orphan_count = result.scalar()
            
            is_valid = orphan_count == 0
            status = "âœ“" if is_valid else "âœ—"
            print(f"  {status} {child_table}.{child_col} â†’ {parent_table}: å­¤ç«‹ãƒ¬ã‚³ãƒ¼ãƒ‰ {orphan_count}ä»¶")
            validations.append(is_valid)
        
        # 4. é‡è¤‡ãƒã‚§ãƒƒã‚¯
        print("\n[é‡è¤‡ãƒã‚§ãƒƒã‚¯]")
        duplicate_checks = [
            ("universities", "name"),
            ("prefectures", "name"),
        ]
        
        for table, column in duplicate_checks:
            result = connection.execute(text(f"""
                SELECT COUNT(*) 
                FROM (
                    SELECT {column}, COUNT(*) as cnt
                    FROM {table}
                    GROUP BY {column}
                    HAVING COUNT(*) > 1
                ) duplicates
            """))
            duplicate_count = result.scalar()
            
            is_valid = duplicate_count == 0
            status = "âœ“" if is_valid else "âœ—"
            print(f"  {status} {table}.{column}: é‡è¤‡ {duplicate_count}ä»¶")
            validations.append(is_valid)
    
    # ç·åˆåˆ¤å®š
    print("\n" + "=" * 60)
    all_valid = all(validations)
    if all_valid:
        print("âœ“ ã™ã¹ã¦ã®æ¤œè¨¼ã«åˆæ ¼ã—ã¾ã—ãŸ")
    else:
        failed_count = validations.count(False)
        print(f"âœ— {failed_count}ä»¶ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ")
    print("=" * 60)
    
    return all_valid

if __name__ == '__main__':
    import sys
    
    if len(sys.argv) != 2:
        print("ä½¿ã„æ–¹: python validate_data.py <DB_URL>")
        sys.exit(1)
    
    db_url = sys.argv[1]
    success = validate_data(db_url)
    sys.exit(0 if success else 1)
```

---

### 2.5 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

#### 2.5.1 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—

```bash
# ç§»è¡Œå‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
#!/bin/bash

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="backups/pre_migration_${TIMESTAMP}"

mkdir -p ${BACKUP_DIR}

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ä½“ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pg_dump -h localhost -U dbuser -d koekyan \
  -F c -f ${BACKUP_DIR}/full_backup.dump

# ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿µã®ãŸã‚ï¼‰
tables=("universities" "faculties" "departments" "prefectures" "grade_levels" "faqs")

for table in "${tables[@]}"; do
  pg_dump -h localhost -U dbuser -d koekyan \
    -t ${table} -F c -f ${BACKUP_DIR}/${table}.dump
done

echo "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: ${BACKUP_DIR}"
```

#### 2.5.2 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

```bash
# ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
#!/bin/bash

if [ $# -ne 1 ]; then
  echo "ä½¿ã„æ–¹: ./rollback.sh <BACKUP_DIR>"
  exit 1
fi

BACKUP_DIR=$1

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã‚¢
pg_restore -h localhost -U dbuser -d koekyan \
  --clean --if-exists \
  ${BACKUP_DIR}/full_backup.dump

echo "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†"
```

---

## 3. ã‚·ã‚¹ãƒ†ãƒ é–“é€£æºè¨­è¨ˆ

### 3.1 é€£æºã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### 3.1.1 å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å£°ã‚­ãƒ£ãƒ³ï¼ã‚·ã‚¹ãƒ†ãƒ                     â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Webã‚¢ãƒ—ãƒª     â”‚â—„â”€â”€â”€â”€â–ºâ”‚ APIã‚µãƒ¼ãƒãƒ¼   â”‚           â”‚
â”‚  â”‚ (Frontend)   â”‚      â”‚ (Backend)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                               â”‚                    â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                        â”‚ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹  â”‚           â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚             â”‚             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ãƒã‚¤ãƒ³ãƒˆäº¤æ›   â”‚ â”‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡ â”‚ â”‚ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥   â”‚
        â”‚API           â”‚ â”‚ã‚µãƒ¼ãƒ“ã‚¹   â”‚ â”‚ã‚µãƒ¼ãƒ“ã‚¹       â”‚
        â”‚(PeXç­‰)       â”‚ â”‚(SendGrid) â”‚ â”‚(FCM)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚             â”‚             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ã‚¨ãƒ©ãƒ¼ç›£è¦–     â”‚ â”‚ã‚¢ã‚¯ã‚»ã‚¹   â”‚ â”‚SMSé€ä¿¡       â”‚
        â”‚(Sentry)      â”‚ â”‚è§£æ(GA)   â”‚ â”‚(å°†æ¥)        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.1.2 é€£æºæ–¹å¼

| ã‚·ã‚¹ãƒ†ãƒ  | é€£æºæ–¹å¼ | ãƒ—ãƒ­ãƒˆã‚³ãƒ« | èªè¨¼æ–¹å¼ |
|----------|----------|------------|----------|
| ãƒã‚¤ãƒ³ãƒˆäº¤æ›API | REST API | HTTPS | APIã‚­ãƒ¼ |
| ãƒ¡ãƒ¼ãƒ«é€ä¿¡ | REST API | HTTPS | APIã‚­ãƒ¼ |
| ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ | SDK/API | HTTPS | ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ |
| ã‚¨ãƒ©ãƒ¼ç›£è¦– | SDK | HTTPS | DSN |
| ã‚¢ã‚¯ã‚»ã‚¹è§£æ | JavaScript SDK | HTTPS | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ID |

---

### 3.2 é€£æºãƒ‘ã‚¿ãƒ¼ãƒ³

#### 3.2.1 åŒæœŸé€£æºï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰

**ç”¨é€”**: ãƒã‚¤ãƒ³ãƒˆäº¤æ›ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡

**ç‰¹å¾´**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¤–éƒ¨APIã‚’å‘¼ã³å‡ºã™
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…ã£ã¦ã‹ã‚‰çµæœã‚’è¿”ã™
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šãŒé‡è¦

**ãƒ•ãƒ­ãƒ¼**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Webã‚¢ãƒ—ãƒª â†’ APIã‚µãƒ¼ãƒãƒ¼ â†’ å¤–éƒ¨API
                              â†“
                         ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾…æ©Ÿ
                              â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â† Webã‚¢ãƒ—ãƒª â† APIã‚µãƒ¼ãƒãƒ¼ â† å¤–éƒ¨API
```

---

#### 3.2.2 éåŒæœŸé€£æºï¼ˆã‚­ãƒ¥ãƒ¼ï¼‰

**ç”¨é€”**: ãƒ¡ãƒ¼ãƒ«ä¸€æ–‰é€ä¿¡ã€ãƒãƒƒãƒå‡¦ç†

**ç‰¹å¾´**:
- ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã—ã¦éåŒæœŸå‡¦ç†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
- ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã‚„ã™ã„

**ãƒ•ãƒ­ãƒ¼**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Webã‚¢ãƒ—ãƒª â†’ APIã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼
                              â†“
                         å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                              â†“
           Webã‚¢ãƒ—ãƒª â† APIã‚µãƒ¼ãƒãƒ¼
           
           (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰)
           ãƒ¯ãƒ¼ã‚«ãƒ¼ â† ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ â†’ å¤–éƒ¨API
```

**æŠ€è¡“é¸æŠè‚¢**:
- Celery (Python)
- Bull (Node.js)
- AWS SQS + Lambda
- Cloud Tasks (GCP)

---

#### 3.2.3 Webhookï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼‰

**ç”¨é€”**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®é€šçŸ¥å—ä¿¡

**ç‰¹å¾´**:
- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆç½²åæ¤œè¨¼ï¼‰ãŒé‡è¦

**ãƒ•ãƒ­ãƒ¼**:
```
å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ â†’ Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â†’ APIã‚µãƒ¼ãƒãƒ¼
                                              â†“
                                        ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
                                              â†“
                                         ãƒ‡ãƒ¼ã‚¿æ›´æ–°
```

---

## 6. å¤–éƒ¨APIé€£æºæ§‹ç¯‰ï¼ˆv2.0ï¼‰

### 6.1 ãƒã‚¤ãƒ³ãƒˆäº¤æ›APIé€£æº ğŸ†•ï¼ˆè‡ªå‹•åŒ–å®Ÿè£…æ¸ˆã¿ï¼‰

#### 6.1.1 é€£æºä»•æ§˜

**æƒ³å®šã‚µãƒ¼ãƒ“ã‚¹**: PeXã€ãƒ‰ãƒƒãƒˆãƒãƒãƒ¼ã€Gãƒã‚¤ãƒ³ãƒˆç­‰

**ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```
POST /api/v1/exchange/request    # ãƒã‚¤ãƒ³ãƒˆäº¤æ›ç”³è«‹
GET  /api/v1/exchange/status/{id}    # äº¤æ›çŠ¶æ³ç¢ºèª
```

**èªè¨¼æ–¹å¼**: APIã‚­ãƒ¼ + HMAC-SHA256ç½²å

**è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¤ãƒ³ãƒˆäº¤æ›ç”³è«‹ï¼ˆ500ptä»¥ä¸Šï¼‰
2. Next.js API Route (`/api/exchange/request`) ãŒè‡ªå‹•çš„ã«å¤–éƒ¨APIã«é€£æº
3. äº¤æ›URL/ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
4. LINE/ãƒ¡ãƒ¼ãƒ«ã§è‡ªå‹•é€šçŸ¥
5. ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã«è¨˜éŒ²

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
- ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ï¼ˆæœ€å¤§3å›ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•æ‰¿èªãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
- ç®¡ç†è€…ã«é€šçŸ¥ï¼ˆSlack/Sentryï¼‰

#### 4.1.2 å®Ÿè£…ä¾‹ï¼ˆPython/FastAPIï¼‰

```python
# app/services/point_exchange_service.py
import httpx
from typing import Optional
from datetime import datetime
import hashlib
import hmac

class PointExchangeService:
    """ãƒã‚¤ãƒ³ãƒˆäº¤æ›ã‚µãƒ¼ãƒ“ã‚¹é€£æº"""
    
    def __init__(self, api_url: str, api_key: str, api_secret: str):
        self.api_url = api_url
        self.api_key = api_key
        self.api_secret = api_secret
        self.client = httpx.AsyncClient(
            base_url=api_url,
            timeout=httpx.Timeout(30.0),  # 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        )
    
    def _generate_signature(self, payload: dict) -> str:
        """ç½²åç”Ÿæˆ"""
        # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ã‚½ãƒ¼ãƒˆã—ã¦æ–‡å­—åˆ—åŒ–
        sorted_payload = sorted(payload.items())
        message = '&'.join([f"{k}={v}" for k, v in sorted_payload])
        
        # HMAC-SHA256ã§ç½²å
        signature = hmac.new(
            self.api_secret.encode(),
            message.encode(),
            hashlib.sha256
        ).hexdigest()
        
        return signature
    
    async def request_exchange(
        self,
        user_id: int,
        points: int,
        user_email: str
    ) -> dict:
        """
        ãƒã‚¤ãƒ³ãƒˆäº¤æ›ç”³è«‹
        
        Args:
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
            points: äº¤æ›ãƒã‚¤ãƒ³ãƒˆæ•°
            user_email: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        
        Returns:
            dict: {
                'success': bool,
                'exchange_id': str,
                'exchange_url': str,
                'message': str
            }
        """
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
        payload = {
            'api_key': self.api_key,
            'user_id': str(user_id),
            'points': points,
            'email': user_email,
            'timestamp': int(datetime.now().timestamp()),
        }
        
        # ç½²åè¿½åŠ 
        payload['signature'] = self._generate_signature(payload)
        
        try:
            # APIå‘¼ã³å‡ºã—
            response = await self.client.post(
                '/api/v1/exchange/request',
                json=payload,
                headers={'Content-Type': 'application/json'}
            )
            
            response.raise_for_status()
            data = response.json()
            
            return {
                'success': True,
                'exchange_id': data['exchange_id'],
                'exchange_url': data['exchange_url'],
                'message': 'ãƒã‚¤ãƒ³ãƒˆäº¤æ›ã‚’ç”³è«‹ã—ã¾ã—ãŸ'
            }
            
        except httpx.HTTPStatusError as e:
            # HTTPã‚¨ãƒ©ãƒ¼
            return {
                'success': False,
                'exchange_id': None,
                'exchange_url': None,
                'message': f'API ã‚¨ãƒ©ãƒ¼: {e.response.status_code}'
            }
            
        except httpx.TimeoutException:
            # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            return {
                'success': False,
                'exchange_id': None,
                'exchange_url': None,
                'message': 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'
            }
            
        except Exception as e:
            # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
            return {
                'success': False,
                'exchange_id': None,
                'exchange_url': None,
                'message': f'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {str(e)}'
            }
    
    async def get_exchange_status(self, exchange_id: str) -> dict:
        """
        äº¤æ›çŠ¶æ³ç¢ºèª
        
        Args:
            exchange_id: äº¤æ›ID
        
        Returns:
            dict: äº¤æ›çŠ¶æ³
        """
        try:
            response = await self.client.get(
                f'/api/v1/exchange/status/{exchange_id}',
                params={'api_key': self.api_key}
            )
            
            response.raise_for_status()
            return response.json()
            
        except Exception as e:
            return {
                'success': False,
                'status': 'error',
                'message': str(e)
            }
    
    async def close(self):
        """ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¯ãƒ­ãƒ¼ã‚º"""
        await self.client.aclose()
```

#### 4.1.3 APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…

```python
# app/api/endpoints/point_exchange.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.services.point_exchange_service import PointExchangeService
from app.services.email_service import EmailService
from app.database import get_db
from app.models import User, PointHistory, PointExchange
from app.schemas import PointExchangeRequest

router = APIRouter()

@router.post('/exchange/request')
async def request_point_exchange(
    request: PointExchangeRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
    point_service: PointExchangeService = Depends(get_point_exchange_service),
    email_service: EmailService = Depends(get_email_service)
):
    """
    ãƒã‚¤ãƒ³ãƒˆäº¤æ›ç”³è«‹
    """
    # ãƒã‚¤ãƒ³ãƒˆæ•°ãƒã‚§ãƒƒã‚¯
    if request.points < 500:
        raise HTTPException(
            status_code=400,
            detail='æœ€ä½äº¤æ›ãƒã‚¤ãƒ³ãƒˆæ•°ã¯500ãƒã‚¤ãƒ³ãƒˆã§ã™'
        )
    
    # ä¿æœ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª
    user_points = db.query(PointHistory)\
        .filter(PointHistory.user_id == current_user.id)\
        .with_entities(func.sum(PointHistory.points))\
        .scalar() or 0
    
    if user_points < request.points:
        raise HTTPException(
            status_code=400,
            detail='ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™'
        )
    
    # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    try:
        # å¤–éƒ¨APIå‘¼ã³å‡ºã—
        result = await point_service.request_exchange(
            user_id=current_user.id,
            points=request.points,
            user_email=current_user.email
        )
        
        if not result['success']:
            raise HTTPException(
                status_code=500,
                detail=result['message']
            )
        
        # ãƒã‚¤ãƒ³ãƒˆæ¸›ç®—
        point_history = PointHistory(
            user_id=current_user.id,
            points=-request.points,
            type='exchange',
            reason='ãƒã‚¤ãƒ³ãƒˆäº¤æ›',
            related_id=result['exchange_id']
        )
        db.add(point_history)
        
        # äº¤æ›å±¥æ­´è¨˜éŒ²
        exchange = PointExchange(
            user_id=current_user.id,
            points=request.points,
            exchange_id=result['exchange_id'],
            exchange_url=result['exchange_url'],
            status='completed'
        )
        db.add(exchange)
        
        db.commit()
        
        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆéåŒæœŸï¼‰
        await email_service.send_exchange_notification(
            to_email=current_user.email,
            exchange_url=result['exchange_url'],
            points=request.points
        )
        
        return {
            'success': True,
            'exchange_id': result['exchange_id'],
            'message': 'ãƒã‚¤ãƒ³ãƒˆäº¤æ›ã‚’ç”³è«‹ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚'
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=str(e))
```

#### 4.1.4 ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½

```python
# app/utils/retry.py
from functools import wraps
import asyncio
from typing import Callable, Any

def async_retry(
    max_attempts: int = 3,
    delay: float = 1.0,
    backoff: float = 2.0,
    exceptions: tuple = (Exception,)
):
    """
    éåŒæœŸé–¢æ•°ã®ãƒªãƒˆãƒ©ã‚¤ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
    
    Args:
        max_attempts: æœ€å¤§è©¦è¡Œå›æ•°
        delay: åˆæœŸå¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰
        backoff: å¾…æ©Ÿæ™‚é–“ã®å€ç‡
        exceptions: ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ã®ä¾‹å¤–
    """
    def decorator(func: Callable) -> Callable:
        @wraps(func)
        async def wrapper(*args, **kwargs) -> Any:
            current_delay = delay
            
            for attempt in range(1, max_attempts + 1):
                try:
                    return await func(*args, **kwargs)
                    
                except exceptions as e:
                    if attempt == max_attempts:
                        # æœ€å¾Œã®è©¦è¡Œã§å¤±æ•—
                        raise
                    
                    # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚°
                    print(f"ãƒªãƒˆãƒ©ã‚¤ {attempt}/{max_attempts}: {str(e)}")
                    
                    # å¾…æ©Ÿ
                    await asyncio.sleep(current_delay)
                    current_delay *= backoff
            
        return wrapper
    return decorator

# ä½¿ç”¨ä¾‹
@async_retry(max_attempts=3, delay=1.0, backoff=2.0)
async def call_external_api():
    # å¤–éƒ¨APIå‘¼ã³å‡ºã—
    pass
```

---

### 4.2 ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹é€£æº

#### 4.2.1 é€£æºä»•æ§˜

**æ¨å¥¨ã‚µãƒ¼ãƒ“ã‚¹**: SendGridã€AWS SESã€Mailgun

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ãƒ«ï¼ˆä¼šå“¡ç™»éŒ²ã€ãƒã‚¤ãƒ³ãƒˆäº¤æ›ç­‰ï¼‰
- ä¸€æ–‰é…ä¿¡ï¼ˆãŠçŸ¥ã‚‰ã›ã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼‰
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†

#### 4.2.2 å®Ÿè£…ä¾‹ï¼ˆSendGridï¼‰

```python
# app/services/email_service.py
from sendgrid import SendGridAPIClient
from sendgrid.helpers.mail import Mail, Email, Content
from typing import List, Optional
import os

class EmailService:
    """ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, api_key: str, from_email: str, from_name: str):
        self.client = SendGridAPIClient(api_key)
        self.from_email = from_email
        self.from_name = from_name
    
    async def send_email(
        self,
        to_email: str,
        subject: str,
        html_content: str,
        text_content: Optional[str] = None,
        template_id: Optional[str] = None,
        dynamic_data: Optional[dict] = None
    ) -> bool:
        """
        ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        
        Args:
            to_email: é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            subject: ä»¶å
            html_content: HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            text_content: ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            template_id: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDï¼ˆSendGridï¼‰
            dynamic_data: å‹•çš„ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨æ™‚ï¼‰
        
        Returns:
            bool: é€ä¿¡æˆåŠŸ/å¤±æ•—
        """
        try:
            message = Mail(
                from_email=Email(self.from_email, self.from_name),
                to_emails=to_email,
                subject=subject,
                html_content=html_content,
                plain_text_content=text_content or ''
            )
            
            # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨æ™‚
            if template_id:
                message.template_id = template_id
                if dynamic_data:
                    message.dynamic_template_data = dynamic_data
            
            # é€ä¿¡
            response = self.client.send(message)
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ç¢ºèª
            if response.status_code in [200, 202]:
                return True
            else:
                print(f"ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    async def send_verification_email(self, to_email: str, verification_url: str) -> bool:
        """ä¼šå“¡ç™»éŒ²ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡"""
        subject = "ã€å£°ã‚­ãƒ£ãƒ³ï¼ã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªã®ãŠé¡˜ã„"
        
        html_content = f"""
        <html>
        <body>
            <h2>å£°ã‚­ãƒ£ãƒ³ï¼ ã¸ã®ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</h2>
            <p>ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
            <p><a href="{verification_url}">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹</a></p>
            <p>ã“ã®ãƒªãƒ³ã‚¯ã¯24æ™‚é–“æœ‰åŠ¹ã§ã™ã€‚</p>
            <hr>
            <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ç ´æ£„ã—ã¦ãã ã•ã„ã€‚</p>
        </body>
        </html>
        """
        
        return await self.send_email(to_email, subject, html_content)
    
    async def send_exchange_notification(
        self,
        to_email: str,
        exchange_url: str,
        points: int
    ) -> bool:
        """ãƒã‚¤ãƒ³ãƒˆäº¤æ›å®Œäº†ãƒ¡ãƒ¼ãƒ«é€ä¿¡"""
        subject = "ã€å£°ã‚­ãƒ£ãƒ³ï¼ã€‘ãƒã‚¤ãƒ³ãƒˆäº¤æ›ãŒå®Œäº†ã—ã¾ã—ãŸ"
        
        html_content = f"""
        <html>
        <body>
            <h2>ãƒã‚¤ãƒ³ãƒˆäº¤æ›ãŒå®Œäº†ã—ã¾ã—ãŸ</h2>
            <p>{points}ãƒã‚¤ãƒ³ãƒˆã®äº¤æ›ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚</p>
            <p>ä»¥ä¸‹ã®URLã‹ã‚‰äº¤æ›æ‰‹ç¶šãã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
            <p><a href="{exchange_url}">äº¤æ›æ‰‹ç¶šãã‚’å®Œäº†ã™ã‚‹</a></p>
            <hr>
            <p>ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</p>
        </body>
        </html>
        """
        
        return await self.send_email(to_email, subject, html_content)
    
    async def send_bulk_email(
        self,
        to_emails: List[str],
        subject: str,
        html_content: str
    ) -> dict:
        """
        ä¸€æ–‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        
        Args:
            to_emails: é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒªã‚¹ãƒˆ
            subject: ä»¶å
            html_content: HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        
        Returns:
            dict: {'success': int, 'failed': int}
        """
        success_count = 0
        failed_count = 0
        
        for email in to_emails:
            result = await self.send_email(email, subject, html_content)
            if result:
                success_count += 1
            else:
                failed_count += 1
        
        return {
            'success': success_count,
            'failed': failed_count
        }
```

#### 4.2.3 ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†

**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§**:
```python
# app/templates/email_templates.py
EMAIL_TEMPLATES = {
    'verification': {
        'subject': 'ã€å£°ã‚­ãƒ£ãƒ³ï¼ã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªã®ãŠé¡˜ã„',
        'template_id': 'd-xxxxxxxxxxxxx',  # SendGrid Template ID
    },
    'welcome': {
        'subject': 'ã€å£°ã‚­ãƒ£ãƒ³ï¼ã€‘ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
        'template_id': 'd-yyyyyyyyyyyyy',
    },
    'point_earned': {
        'subject': 'ã€å£°ã‚­ãƒ£ãƒ³ï¼ã€‘ãƒã‚¤ãƒ³ãƒˆãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸ',
        'template_id': 'd-zzzzzzzzzzzzz',
    },
    'exchange_completed': {
        'subject': 'ã€å£°ã‚­ãƒ£ãƒ³ï¼ã€‘ãƒã‚¤ãƒ³ãƒˆäº¤æ›ãŒå®Œäº†ã—ã¾ã—ãŸ',
        'template_id': 'd-aaaaaaaaaaaa',
    },
    'new_survey': {
        'subject': 'ã€å£°ã‚­ãƒ£ãƒ³ï¼ã€‘æ–°ã—ã„ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ',
        'template_id': 'd-bbbbbbbbbbbb',
    },
}
```

---

### 6.3 LINE Messaging APIé€£æº ğŸ†•

#### 6.3.1 LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

1. **LINE Developers ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**
   - https://developers.line.biz/ ã«ã‚¢ã‚¯ã‚»ã‚¹
   - LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³

2. **ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ä½œæˆ**
   - ã€ŒCreateã€â†’ã€ŒProviderã€ã‚’é¸æŠ
   - ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å: `å£°ã‚­ãƒ£ãƒ³ï¼`

3. **Messaging API ãƒãƒ£ãƒãƒ«ä½œæˆ**
   - ã€ŒCreateã€â†’ã€ŒMessaging APIã€ã‚’é¸æŠ
   - ãƒãƒ£ãƒãƒ«å: `å£°ã‚­ãƒ£ãƒ³ï¼å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ`
   - ã‚«ãƒ†ã‚´ãƒª: `ã‚¢ãƒ—ãƒªãƒ»ã‚µãƒ¼ãƒ“ã‚¹`
   - ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª: `ãã®ä»–`
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

4. **ãƒãƒ£ãƒãƒ«æƒ…å ±ã®ç¢ºèª**
   - Channel ID: `1234567890`
   - Channel Secret: `xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
   - Channel Access Token: å¾Œã§ç™ºè¡Œ

#### 6.3.2 Channel Access Tokenç™ºè¡Œ

1. LINE Developers Consoleã§ãƒãƒ£ãƒãƒ«ã‚’é¸æŠ
2. ã€ŒMessaging APIã€ã‚¿ãƒ–ã‚’é–‹ã
3. ã€ŒIssueã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ
4. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ã«ä¿å­˜ï¼ˆå†è¡¨ç¤ºä¸å¯ï¼‰

#### 6.3.3 Webhook URLè¨­å®š

**Next.js API Routeä½œæˆ**:

```typescript
// app/api/webhooks/line/route.ts
import { NextRequest, NextResponse } from 'next/server';
import crypto from 'crypto';

export async function POST(request: NextRequest) {
  try {
    const body = await request.text();
    const signature = request.headers.get('x-line-signature');
    
    // ç½²åæ¤œè¨¼
    const channelSecret = process.env.LINE_CHANNEL_SECRET!;
    const hash = crypto
      .createHmac('sha256', channelSecret)
      .update(body)
      .digest('base64');
    
    if (hash !== signature) {
      return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
    }
    
    const events = JSON.parse(body).events;
    
    // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
    for (const event of events) {
      if (event.type === 'follow') {
        // å‹ã ã¡è¿½åŠ æ™‚ã®å‡¦ç†
        await handleFollowEvent(event);
      } else if (event.type === 'message') {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†
        await handleMessageEvent(event);
      }
    }
    
    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('LINE Webhook error:', error);
    return NextResponse.json({ error: 'Internal error' }, { status: 500 });
  }
}

async function handleFollowEvent(event: any) {
  // å‹ã ã¡è¿½åŠ æ™‚ã®å‡¦ç†
  // LINE User IDã‚’ä¿å­˜ç­‰
}

async function handleMessageEvent(event: any) {
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†
}
```

**Webhook URLè¨­å®š**:
1. LINE Developers Consoleã§ãƒãƒ£ãƒãƒ«ã‚’é¸æŠ
2. ã€ŒMessaging APIã€ã‚¿ãƒ–ã®ã€ŒWebhook URLã€ã«è¨­å®š
   - URL: `https://your-domain.com/api/webhooks/line`
   - ã€ŒUse webhookã€ã‚’æœ‰åŠ¹åŒ–
3. ã€ŒVerifyã€ãƒœã‚¿ãƒ³ã§å‹•ä½œç¢ºèª

#### 6.3.4 LINEé€šçŸ¥é€ä¿¡å®Ÿè£…

```typescript
// lib/line.ts
export async function sendLineMessage(
  lineUserId: string,
  message: string
): Promise<boolean> {
  const channelAccessToken = process.env.LINE_CHANNEL_ACCESS_TOKEN!;
  
  try {
    const response = await fetch('https://api.line.me/v2/bot/message/push', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${channelAccessToken}`
      },
      body: JSON.stringify({
        to: lineUserId,
        messages: [
          {
            type: 'text',
            text: message
          }
        ]
      })
    });
    
    return response.ok;
  } catch (error) {
    console.error('LINEé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}
```

**ç’°å¢ƒå¤‰æ•°è¨­å®š**:
```bash
# .env.local
LINE_CHANNEL_ID=1234567890
LINE_CHANNEL_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
LINE_CHANNEL_ACCESS_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

---

### 6.4 ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹é€£æº ğŸ†•ï¼ˆFirebase Cloud Messagingï¼‰

#### 6.4.1 Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

1. **Firebase Console ã«ã‚¢ã‚¯ã‚»ã‚¹**
   - https://console.firebase.google.com/
   - Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³

2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ**
   - ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: `koekyan`ï¼ˆå£°ã‚­ãƒ£ãƒ³ï¼ï¼‰
   - Google Analytics: æœ‰åŠ¹åŒ–æ¨å¥¨

3. **Webã‚¢ãƒ—ãƒªã‚’è¿½åŠ **
   - ã€Œ</>ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ã‚¢ãƒ—ãƒªã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : `å£°ã‚­ãƒ£ãƒ³ï¼Web`
   - Firebase Hosting: ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

4. **è¨­å®šæƒ…å ±ã®å–å¾—**
   - Firebase SDKè¨­å®šã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - `apiKey`, `authDomain`, `projectId` ç­‰ã‚’ã‚³ãƒ”ãƒ¼

#### 6.4.2 VAPIDéµã®ç”Ÿæˆ

```bash
# Node.jsã§VAPIDéµã‚’ç”Ÿæˆ
npm install -g web-push
web-push generate-vapid-keys
```

**å‡ºåŠ›ä¾‹**:
```
Public Key:
BGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Private Key:
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

#### 6.4.3 Firebaseè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

```typescript
// lib/firebase.ts
import { initializeApp, getApps } from 'firebase/app';
import { getMessaging, getToken, onMessage } from 'firebase/messaging';

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID
};

if (!getApps().length) {
  initializeApp(firebaseConfig);
}

// Service Workerç™»éŒ²
export async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    const registration = await navigator.serviceWorker.register('/sw.js');
    return registration;
  }
  return null;
}

// FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
export async function getFCMToken(): Promise<string | null> {
  const registration = await registerServiceWorker();
  if (!registration) return null;
  
  const messaging = getMessaging();
  const token = await getToken(messaging, {
    vapidKey: process.env.NEXT_PUBLIC_FIREBASE_VAPID_KEY
  });
  
  return token;
}
```

#### 6.4.4 Service Workerå®Ÿè£…

```javascript
// public/sw.js
importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js');

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();

// ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
messaging.onBackgroundMessage((payload) => {
  const notificationTitle = payload.notification.title;
  const notificationOptions = {
    body: payload.notification.body,
    icon: '/icon-192x192.png',
    badge: '/badge-72x72.png'
  };
  
  self.registration.showNotification(notificationTitle, notificationOptions);
});
```

#### 6.4.5 ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡API

```typescript
// app/api/notifications/push/route.ts
import { NextRequest, NextResponse } from 'next/server';
import admin from 'firebase-admin';

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert({
      projectId: process.env.FIREBASE_PROJECT_ID,
      clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
      privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n')
    })
  });
}

export async function POST(request: NextRequest) {
  try {
    const { userId, title, body, data } = await request.json();
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆSupabaseã‹ã‚‰ï¼‰
    const { createClient } = await import('@supabase/supabase-js');
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
    
    const { data: subscription } = await supabase
      .from('push_subscriptions')
      .select('endpoint, p256dh, auth')
      .eq('user_id', userId)
      .single();
    
    if (!subscription) {
      return NextResponse.json({ error: 'No subscription found' }, { status: 404 });
    }
    
    // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
    const message = {
      notification: {
        title,
        body
      },
      data: data || {},
      token: subscription.endpoint // FCMãƒˆãƒ¼ã‚¯ãƒ³
    };
    
    const response = await admin.messaging().send(message);
    
    return NextResponse.json({ success: true, messageId: response });
  } catch (error) {
    console.error('Push notification error:', error);
    return NextResponse.json({ error: 'Failed to send' }, { status: 500 });
  }
}
```

**ç’°å¢ƒå¤‰æ•°è¨­å®š**:
```bash
# .env.local
NEXT_PUBLIC_FIREBASE_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=koekyan.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=koekyan
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=koekyan.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789012
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789012:web:xxxxxxxxxxxxxxxxxxxxxxxx
NEXT_PUBLIC_FIREBASE_VAPID_KEY=BGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# .envï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼‰
FIREBASE_PROJECT_ID=koekyan
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@koekyan.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
```

---

### 6.5 ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹é€£æºï¼ˆæ—§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

**å®Ÿè£…ä¾‹**:
```python
# app/services/push_notification_service.py
from firebase_admin import messaging
import firebase_admin
from firebase_admin import credentials

class PushNotificationService:
    """ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, credentials_path: str):
        cred = credentials.Certificate(credentials_path)
        firebase_admin.initialize_app(cred)
    
    async def send_notification(
        self,
        token: str,
        title: str,
        body: str,
        data: dict = None
    ) -> bool:
        """
        ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
        
        Args:
            token: FCMãƒˆãƒ¼ã‚¯ãƒ³
            title: é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«
            body: é€šçŸ¥æœ¬æ–‡
            data: ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿
        
        Returns:
            bool: é€ä¿¡æˆåŠŸ/å¤±æ•—
        """
        message = messaging.Message(
            notification=messaging.Notification(
                title=title,
                body=body,
            ),
            data=data or {},
            token=token,
        )
        
        try:
            response = messaging.send(message)
            print(f'ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡æˆåŠŸ: {response}')
            return True
        except Exception as e:
            print(f'ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}')
            return False
    
    async def send_to_multiple(
        self,
        tokens: list,
        title: str,
        body: str,
        data: dict = None
    ) -> dict:
        """
        è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
        
        Returns:
            dict: {'success': int, 'failed': int}
        """
        message = messaging.MulticastMessage(
            notification=messaging.Notification(
                title=title,
                body=body,
            ),
            data=data or {},
            tokens=tokens,
        )
        
        try:
            response = messaging.send_multicast(message)
            return {
                'success': response.success_count,
                'failed': response.failure_count
            }
        except Exception as e:
            print(f'ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}')
            return {'success': 0, 'failed': len(tokens)}
```

---

### 4.4 ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹é€£æº

#### 4.4.1 Sentryé€£æº

```python
# app/main.py
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

# SentryåˆæœŸåŒ–
sentry_sdk.init(
    dsn="https://xxxxx@xxxxx.ingest.sentry.io/xxxxx",
    integrations=[FastApiIntegration()],
    traces_sample_rate=1.0,  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
    environment="production",  # ç’°å¢ƒ
)

# ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ
def report_error(error: Exception, context: dict = None):
    """ã‚¨ãƒ©ãƒ¼ã‚’Sentryã«å ±å‘Š"""
    with sentry_sdk.push_scope() as scope:
        if context:
            for key, value in context.items():
                scope.set_context(key, value)
        sentry_sdk.capture_exception(error)
```

---

## 5. ãƒ‡ãƒ¼ã‚¿åŒæœŸ

### 5.1 åŒæœŸæˆ¦ç•¥

#### 5.1.1 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ

**å¯¾è±¡ãƒ‡ãƒ¼ã‚¿**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ã€ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼‰
- é‡è¦ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿

**å®Ÿè£…æ–¹å¼**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒˆãƒªã‚¬ãƒ¼
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ

#### 5.1.2 ãƒãƒƒãƒåŒæœŸ

**å¯¾è±¡ãƒ‡ãƒ¼ã‚¿**:
- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿

**å®Ÿè£…æ–¹å¼**:
- Cronã‚¸ãƒ§ãƒ–
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ï¼ˆCelery Beatç­‰ï¼‰

**å®Ÿè£…ä¾‹**:
```python
# app/tasks/sync_tasks.py
from celery import Celery
from celery.schedules import crontab

app = Celery('tasks')

# æ—¥æ¬¡é›†è¨ˆï¼ˆæ¯æ—¥åˆå‰3æ™‚ï¼‰
@app.task
def daily_aggregation():
    """æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ"""
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°é›†è¨ˆ
    # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”æ•°é›†è¨ˆ
    # ãƒã‚¤ãƒ³ãƒˆç™ºè¡Œæ•°é›†è¨ˆ
    pass

# é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ¯é€±æœˆæ›œåˆå‰6æ™‚ï¼‰
@app.task
def weekly_report():
    """é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"""
    pass

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
app.conf.beat_schedule = {
    'daily-aggregation': {
        'task': 'app.tasks.sync_tasks.daily_aggregation',
        'schedule': crontab(hour=3, minute=0),
    },
    'weekly-report': {
        'task': 'app.tasks.sync_tasks.weekly_report',
        'schedule': crontab(day_of_week=1, hour=6, minute=0),
    },
}
```

---

### 5.2 ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§

#### 5.2.1 ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

```python
# app/services/transaction_service.py
from sqlalchemy.orm import Session
from contextlib import contextmanager

@contextmanager
def transaction_scope(db: Session):
    """ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚³ãƒ¼ãƒ—"""
    try:
        yield db
        db.commit()
    except Exception as e:
        db.rollback()
        raise e

# ä½¿ç”¨ä¾‹
async def award_points_for_survey(user_id: int, survey_id: int, points: int):
    """ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ã§ãƒã‚¤ãƒ³ãƒˆä»˜ä¸"""
    with transaction_scope(db) as session:
        # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è¨˜éŒ²
        response = SurveyResponse(
            user_id=user_id,
            survey_id=survey_id,
            ...
        )
        session.add(response)
        
        # ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
        point_history = PointHistory(
            user_id=user_id,
            points=points,
            type='earned',
            reason='ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”',
            related_id=survey_id
        )
        session.add(point_history)
        
        # ä¸¡æ–¹æˆåŠŸã—ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
```

#### 5.2.2 å†ªç­‰æ€§ã®ç¢ºä¿

```python
# app/utils/idempotency.py
import hashlib
from functools import wraps

class IdempotencyService:
    """å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def generate_key(self, user_id: int, action: str, params: dict) -> str:
        """å†ªç­‰æ€§ã‚­ãƒ¼ç”Ÿæˆ"""
        data = f"{user_id}:{action}:{str(params)}"
        return hashlib.sha256(data.encode()).hexdigest()
    
    def is_duplicate(self, key: str) -> bool:
        """é‡è¤‡ãƒã‚§ãƒƒã‚¯"""
        result = self.db.query(IdempotencyRecord)\
            .filter(IdempotencyRecord.key == key)\
            .first()
        return result is not None
    
    def record(self, key: str, response: dict):
        """å®Ÿè¡Œè¨˜éŒ²"""
        record = IdempotencyRecord(
            key=key,
            response=response,
            created_at=datetime.now()
        )
        self.db.add(record)
        self.db.commit()

# ä½¿ç”¨ä¾‹
@router.post('/survey/submit')
async def submit_survey(
    request: SurveySubmitRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    idempotency = IdempotencyService(db)
    
    # å†ªç­‰æ€§ã‚­ãƒ¼ç”Ÿæˆ
    key = idempotency.generate_key(
        user_id=current_user.id,
        action='submit_survey',
        params={'survey_id': request.survey_id}
    )
    
    # é‡è¤‡ãƒã‚§ãƒƒã‚¯
    if idempotency.is_duplicate(key):
        raise HTTPException(
            status_code=409,
            detail='ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯æ—¢ã«å›ç­”æ¸ˆã¿ã§ã™'
        )
    
    # å‡¦ç†å®Ÿè¡Œ
    result = await process_survey_submission(request, current_user)
    
    # å®Ÿè¡Œè¨˜éŒ²
    idempotency.record(key, result)
    
    return result
```

---

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 6.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡

| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | èª¬æ˜ | å¯¾å¿œ |
|------------|------|------|
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€æ¥ç¶šå¤±æ•— | ãƒªãƒˆãƒ©ã‚¤ |
| èªè¨¼ã‚¨ãƒ©ãƒ¼ | APIã‚­ãƒ¼ç„¡åŠ¹ã€æ¨©é™ä¸è¶³ | è¨­å®šç¢ºèªã€ã‚¢ãƒ©ãƒ¼ãƒˆ |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸æ­£ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | APIå‘¼ã³å‡ºã—ä¸Šé™ | å¾…æ©Ÿå¾Œãƒªãƒˆãƒ©ã‚¤ |
| ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ | å¤–éƒ¨APIéšœå®³ | ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆ |

### 6.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…

```python
# app/utils/error_handler.py
from enum import Enum
from typing import Optional, Callable
import asyncio

class ErrorSeverity(Enum):
    """ã‚¨ãƒ©ãƒ¼é‡è¦åº¦"""
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"

class ErrorHandler:
    """çµ±åˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼"""
    
    @staticmethod
    async def handle_api_error(
        error: Exception,
        severity: ErrorSeverity,
        fallback: Optional[Callable] = None,
        alert: bool = True
    ):
        """
        API ã‚¨ãƒ©ãƒ¼å‡¦ç†
        
        Args:
            error: ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼
            severity: é‡è¦åº¦
            fallback: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
            alert: ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ãƒ•ãƒ©ã‚°
        """
        # ãƒ­ã‚°è¨˜éŒ²
        log_error(error, severity)
        
        # Sentryå ±å‘Š
        if severity in [ErrorSeverity.HIGH, ErrorSeverity.CRITICAL]:
            report_to_sentry(error)
        
        # ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
        if alert and severity == ErrorSeverity.CRITICAL:
            await send_alert_to_slack(error)
        
        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
        if fallback:
            return await fallback()
        
        return None

# ä½¿ç”¨ä¾‹
async def call_external_api_with_handling():
    try:
        result = await call_external_api()
        return result
    except TimeoutError as e:
        return await ErrorHandler.handle_api_error(
            error=e,
            severity=ErrorSeverity.MEDIUM,
            fallback=lambda: {'status': 'pending'},
            alert=False
        )
    except Exception as e:
        return await ErrorHandler.handle_api_error(
            error=e,
            severity=ErrorSeverity.HIGH,
            fallback=None,
            alert=True
        )
```

### 6.3 ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
# app/utils/circuit_breaker.py
from enum import Enum
from datetime import datetime, timedelta
from typing import Callable, Any

class CircuitState(Enum):
    """ã‚µãƒ¼ã‚­ãƒƒãƒˆçŠ¶æ…‹"""
    CLOSED = "closed"      # æ­£å¸¸
    OPEN = "open"          # éšœå®³æ¤œçŸ¥ã€å‘¼ã³å‡ºã—åœæ­¢
    HALF_OPEN = "half_open"  # å›å¾©ç¢ºèªä¸­

class CircuitBreaker:
    """ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼"""
    
    def __init__(
        self,
        failure_threshold: int = 5,
        timeout: int = 60,
        recovery_timeout: int = 30
    ):
        self.failure_threshold = failure_threshold  # å¤±æ•—å›æ•°é–¾å€¤
        self.timeout = timeout  # ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã®ç¶™ç¶šæ™‚é–“ï¼ˆç§’ï¼‰
        self.recovery_timeout = recovery_timeout  # ãƒªã‚«ãƒãƒªãƒ¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        
        self.failure_count = 0
        self.state = CircuitState.CLOSED
        self.last_failure_time = None
        self.last_attempt_time = None
    
    async def call(self, func: Callable, *args, **kwargs) -> Any:
        """
        é–¢æ•°å‘¼ã³å‡ºã—ï¼ˆã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼é©ç”¨ï¼‰
        
        Args:
            func: å‘¼ã³å‡ºã™é–¢æ•°
            *args, **kwargs: é–¢æ•°ã®å¼•æ•°
        
        Returns:
            é–¢æ•°ã®æˆ»ã‚Šå€¤
        
        Raises:
            CircuitBreakerOpenError: ã‚µãƒ¼ã‚­ãƒƒãƒˆãŒã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹
        """
        # ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        if self.state == CircuitState.OPEN:
            if self._should_attempt_reset():
                self.state = CircuitState.HALF_OPEN
            else:
                raise CircuitBreakerOpenError("ã‚µãƒ¼ã‚­ãƒƒãƒˆãŒã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã§ã™")
        
        try:
            # é–¢æ•°å®Ÿè¡Œ
            result = await func(*args, **kwargs)
            
            # æˆåŠŸæ™‚
            self._on_success()
            return result
            
        except Exception as e:
            # å¤±æ•—æ™‚
            self._on_failure()
            raise e
    
    def _should_attempt_reset(self) -> bool:
        """ãƒªã‚»ãƒƒãƒˆè©¦è¡Œåˆ¤å®š"""
        if self.last_failure_time is None:
            return True
        
        elapsed = (datetime.now() - self.last_failure_time).total_seconds()
        return elapsed >= self.timeout
    
    def _on_success(self):
        """æˆåŠŸæ™‚ã®å‡¦ç†"""
        self.failure_count = 0
        self.state = CircuitState.CLOSED
    
    def _on_failure(self):
        """å¤±æ•—æ™‚ã®å‡¦ç†"""
        self.failure_count += 1
        self.last_failure_time = datetime.now()
        
        if self.failure_count >= self.failure_threshold:
            self.state = CircuitState.OPEN

class CircuitBreakerOpenError(Exception):
    """ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼"""
    pass

# ä½¿ç”¨ä¾‹
point_exchange_breaker = CircuitBreaker(
    failure_threshold=5,
    timeout=60
)

async def exchange_points_with_breaker(user_id, points):
    """ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼é©ç”¨ã®ãƒã‚¤ãƒ³ãƒˆäº¤æ›"""
    try:
        return await point_exchange_breaker.call(
            exchange_points,
            user_id,
            points
        )
    except CircuitBreakerOpenError:
        # ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚ªãƒ¼ãƒ—ãƒ³æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return {
            'success': False,
            'message': 'ãƒã‚¤ãƒ³ãƒˆäº¤æ›ã‚µãƒ¼ãƒ“ã‚¹ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“'
        }
```

---

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 7.1 APIèªè¨¼

#### 7.1.1 APIã‚­ãƒ¼ç®¡ç†

```python
# app/config/api_keys.py
from pydantic_settings import BaseSettings

class APIKeys(BaseSettings):
    """API ã‚­ãƒ¼è¨­å®š"""
    
    # ãƒã‚¤ãƒ³ãƒˆäº¤æ›API
    POINT_EXCHANGE_API_URL: str
    POINT_EXCHANGE_API_KEY: str
    POINT_EXCHANGE_API_SECRET: str
    
    # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    SENDGRID_API_KEY: str
    
    # ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥
    FCM_CREDENTIALS_PATH: str
    
    # ã‚¨ãƒ©ãƒ¼ç›£è¦–
    SENTRY_DSN: str
    
    class Config:
        env_file = ".env"
        case_sensitive = True

# ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
api_keys = APIKeys()
```

#### 7.1.2 ç’°å¢ƒå¤‰æ•°ç®¡ç†

```.env
# .env.example
# ãƒã‚¤ãƒ³ãƒˆäº¤æ›API
POINT_EXCHANGE_API_URL=https://api.point-exchange.example.com
POINT_EXCHANGE_API_KEY=your_api_key_here
POINT_EXCHANGE_API_SECRET=your_api_secret_here

# ãƒ¡ãƒ¼ãƒ«é€ä¿¡
SENDGRID_API_KEY=SG.xxxxxxxxxxxxxxxxxxxxx

# ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥
FCM_CREDENTIALS_PATH=/path/to/firebase-credentials.json

# ã‚¨ãƒ©ãƒ¼ç›£è¦–
SENTRY_DSN=https://xxxxx@xxxxx.ingest.sentry.io/xxxxx

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
DATABASE_URL=postgresql://user:password@localhost:5432/koekyan

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
SECRET_KEY=your_secret_key_here
JWT_SECRET_KEY=your_jwt_secret_here
```

**æ³¨æ„äº‹é …**:
- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `.gitignore` ã«è¿½åŠ 
- æœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨
- å®šæœŸçš„ãªãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

---

### 7.2 é€šä¿¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### 7.2.1 HTTPSé€šä¿¡ã®å¼·åˆ¶

```python
# app/middleware/security.py
from fastapi import Request
from fastapi.responses import RedirectResponse

async def https_redirect_middleware(request: Request, call_next):
    """HTTPâ†’HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ"""
    if request.url.scheme != "https" and not request.url.hostname == "localhost":
        url = request.url.replace(scheme="https")
        return RedirectResponse(url)
    
    response = await call_next(request)
    return response
```

#### 7.2.2 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```python
# app/middleware/rate_limit.py
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

# ä½¿ç”¨ä¾‹
@app.get("/api/surveys")
@limiter.limit("100/minute")  # 1åˆ†é–“ã«100ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§
async def get_surveys(request: Request):
    pass
```

---

### 7.3 ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–

#### 7.3.1 æ©Ÿå¯†æƒ…å ±ã®æš—å·åŒ–

```python
# app/utils/encryption.py
from cryptography.fernet import Fernet
import base64

class EncryptionService:
    """æš—å·åŒ–ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, key: str):
        self.fernet = Fernet(key.encode())
    
    def encrypt(self, data: str) -> str:
        """æš—å·åŒ–"""
        encrypted = self.fernet.encrypt(data.encode())
        return base64.b64encode(encrypted).decode()
    
    def decrypt(self, encrypted_data: str) -> str:
        """å¾©å·åŒ–"""
        decoded = base64.b64decode(encrypted_data.encode())
        decrypted = self.fernet.decrypt(decoded)
        return decrypted.decode()

# ä½¿ç”¨ä¾‹ï¼ˆAPIã‚­ãƒ¼ã®æš—å·åŒ–ä¿å­˜ï¼‰
encryption = EncryptionService(os.getenv('ENCRYPTION_KEY'))

# æš—å·åŒ–ã—ã¦ä¿å­˜
encrypted_api_key = encryption.encrypt(api_key)
db.save(encrypted_api_key)

# å¾©å·åŒ–ã—ã¦ä½¿ç”¨
api_key = encryption.decrypt(stored_encrypted_key)
```

---

## 8. ç›£è¦–ã¨ãƒ­ã‚°

### 8.1 é€£æºç›£è¦–

#### 8.1.1 ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```python
# app/api/endpoints/health.py
from fastapi import APIRouter, HTTPException
from app.services.point_exchange_service import PointExchangeService
from app.services.email_service import EmailService

router = APIRouter()

@router.get('/health')
async def health_check():
    """ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
    return {
        'status': 'healthy',
        'timestamp': datetime.now().isoformat()
    }

@router.get('/health/dependencies')
async def dependencies_health_check(
    point_service: PointExchangeService = Depends(get_point_exchange_service),
    email_service: EmailService = Depends(get_email_service)
):
    """å¤–éƒ¨ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
    results = {}
    
    # ãƒã‚¤ãƒ³ãƒˆäº¤æ›APIãƒã‚§ãƒƒã‚¯
    try:
        # ç°¡æ˜“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        await point_service.ping()
        results['point_exchange_api'] = {'status': 'healthy'}
    except Exception as e:
        results['point_exchange_api'] = {'status': 'unhealthy', 'error': str(e)}
    
    # ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚§ãƒƒã‚¯
    try:
        # ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
        await email_service.ping()
        results['email_service'] = {'status': 'healthy'}
    except Exception as e:
        results['email_service'] = {'status': 'unhealthy', 'error': str(e)}
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯
    try:
        db.execute("SELECT 1")
        results['database'] = {'status': 'healthy'}
    except Exception as e:
        results['database'] = {'status': 'unhealthy', 'error': str(e)}
    
    # ç·åˆåˆ¤å®š
    overall_status = 'healthy' if all(
        r['status'] == 'healthy' for r in results.values()
    ) else 'degraded'
    
    return {
        'status': overall_status,
        'dependencies': results,
        'timestamp': datetime.now().isoformat()
    }
```

#### 8.1.2 APIå‘¼ã³å‡ºã—ãƒ­ã‚°

```python
# app/utils/api_logger.py
import logging
from datetime import datetime

class APILogger:
    """APIå‘¼ã³å‡ºã—ãƒ­ã‚°"""
    
    def __init__(self):
        self.logger = logging.getLogger('api_calls')
    
    def log_request(
        self,
        service: str,
        endpoint: str,
        method: str,
        params: dict = None
    ):
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°"""
        self.logger.info({
            'type': 'api_request',
            'service': service,
            'endpoint': endpoint,
            'method': method,
            'params': params,
            'timestamp': datetime.now().isoformat()
        })
    
    def log_response(
        self,
        service: str,
        endpoint: str,
        status_code: int,
        duration: float,
        success: bool
    ):
        """ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ­ã‚°"""
        self.logger.info({
            'type': 'api_response',
            'service': service,
            'endpoint': endpoint,
            'status_code': status_code,
            'duration_ms': duration * 1000,
            'success': success,
            'timestamp': datetime.now().isoformat()
        })
    
    def log_error(
        self,
        service: str,
        endpoint: str,
        error: str
    ):
        """ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°"""
        self.logger.error({
            'type': 'api_error',
            'service': service,
            'endpoint': endpoint,
            'error': error,
            'timestamp': datetime.now().isoformat()
        })
```

---

### 8.2 ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†

```python
# app/utils/metrics.py
from prometheus_client import Counter, Histogram, Gauge

# APIå‘¼ã³å‡ºã—å›æ•°
api_calls_total = Counter(
    'api_calls_total',
    'Total API calls',
    ['service', 'endpoint', 'status']
)

# API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
api_response_time = Histogram(
    'api_response_time_seconds',
    'API response time',
    ['service', 'endpoint']
)

# ç¾åœ¨ã®åŒæ™‚æ¥ç¶šæ•°
concurrent_requests = Gauge(
    'concurrent_requests',
    'Current concurrent requests',
    ['service']
)

# ä½¿ç”¨ä¾‹
async def call_external_api(service: str, endpoint: str):
    """ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ä»˜ãAPIå‘¼ã³å‡ºã—"""
    concurrent_requests.labels(service=service).inc()
    
    start_time = time.time()
    
    try:
        response = await make_api_call(endpoint)
        status = 'success'
        return response
        
    except Exception as e:
        status = 'error'
        raise e
        
    finally:
        duration = time.time() - start_time
        
        api_calls_total.labels(
            service=service,
            endpoint=endpoint,
            status=status
        ).inc()
        
        api_response_time.labels(
            service=service,
            endpoint=endpoint
        ).observe(duration)
        
        concurrent_requests.labels(service=service).dec()
```

---

## 8. Next.js/Vercelãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ï¼ˆv2.0ï¼‰

### 8.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæº–å‚™

#### 8.1.1 Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

```bash
# Next.js 14ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
npx create-next-app@latest koekyan --typescript --tailwind --app --no-src-dir

cd koekyan

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install @supabase/supabase-js @supabase/auth-helpers-nextjs
npm install firebase firebase-admin
npm install @line/bot-sdk
npm install sendgrid
npm install zod
npm install date-fns
```

#### 8.1.2 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
koekyan/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/              # API Routes
â”‚   â”‚   â”œâ”€â”€ exchange/     # ãƒã‚¤ãƒ³ãƒˆäº¤æ›API
â”‚   â”‚   â”œâ”€â”€ notifications/ # é€šçŸ¥API
â”‚   â”‚   â””â”€â”€ webhooks/     # Webhookï¼ˆLINEç­‰ï¼‰
â”‚   â”œâ”€â”€ (auth)/           # èªè¨¼é–¢é€£ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ (monitor)/        # ãƒ¢ãƒ‹ã‚¿ãƒ¼å‘ã‘ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ (client)/         # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ (admin)/          # ç®¡ç†è€…å‘ã‘ãƒšãƒ¼ã‚¸
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ components/           # å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ lib/                  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”œâ”€â”€ supabase.ts      # Supabase Client
â”‚   â”œâ”€â”€ firebase.ts      # Firebaseè¨­å®š
â”‚   â””â”€â”€ line.ts          # LINEé€£æº
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ sw.js            # Service Worker
â”‚   â””â”€â”€ manifest.json    # PWAè¨­å®š
â”œâ”€â”€ .env.local           # ç’°å¢ƒå¤‰æ•°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
â””â”€â”€ next.config.js
```

### 8.2 Vercelãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

#### 8.2.1 Vercelã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

1. **Vercelã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**
   - https://vercel.com ã«ã‚¢ã‚¯ã‚»ã‚¹
   - GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰

2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ**
   - ã€ŒAdd New...ã€â†’ã€ŒProjectã€ã‚’é¸æŠ
   - GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠ
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: `koekyan`

#### 8.2.2 ç’°å¢ƒå¤‰æ•°è¨­å®š

Vercel Dashboardã§ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼š

**Supabaseé–¢é€£**:
```
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**LINEé–¢é€£**:
```
LINE_CHANNEL_ID=1234567890
LINE_CHANNEL_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
LINE_CHANNEL_ACCESS_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**Firebaseé–¢é€£**:
```
NEXT_PUBLIC_FIREBASE_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=koekyan.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=koekyan
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=koekyan.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789012
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789012:web:xxxxxxxxxxxxxxxxxxxxxxxx
NEXT_PUBLIC_FIREBASE_VAPID_KEY=BGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
FIREBASE_PROJECT_ID=koekyan
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@koekyan.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
```

**ãƒã‚¤ãƒ³ãƒˆäº¤æ›APIé–¢é€£**:
```
POINT_EXCHANGE_API_URL=https://api.point-exchange.example.com
POINT_EXCHANGE_API_KEY=your_api_key_here
POINT_EXCHANGE_API_SECRET=your_api_secret_here
```

**ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–¢é€£**:
```
SENDGRID_API_KEY=SG.xxxxxxxxxxxxxxxxxxxxx
SENDGRID_FROM_EMAIL=noreply@koekyan.example.com
SENDGRID_FROM_NAME=å£°ã‚­ãƒ£ãƒ³ï¼
```

**ãã®ä»–**:
```
NEXT_PUBLIC_APP_URL=https://koekyan.vercel.app
SENTRY_DSN=https://xxxxx@xxxxx.ingest.sentry.io/xxxxx
```

#### 8.2.3 ãƒ“ãƒ«ãƒ‰è¨­å®š

**next.config.js**:
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
  images: {
    domains: ['xxxxx.supabase.co'],
  },
  // PWAè¨­å®š
  async headers() {
    return [
      {
        source: '/sw.js',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=0, must-revalidate',
          },
        ],
      },
    ];
  },
};

module.exports = nextConfig;
```

### 8.3 ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ

#### 8.3.1 åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤

1. **GitHubã«ãƒ—ãƒƒã‚·ãƒ¥**
   ```bash
   git add .
   git commit -m "Initial commit"
   git push origin main
   ```

2. **Vercelã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤**
   - GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹
   - ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèª

3. **ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèª**
   - ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã€æä¾›ã•ã‚ŒãŸURLã§ã‚¢ã‚¯ã‚»ã‚¹
   - å‹•ä½œç¢ºèª

#### 8.3.2 ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š

1. **Vercel Dashboardã§ãƒ‰ãƒ¡ã‚¤ãƒ³è¿½åŠ **
   - ã€ŒSettingsã€â†’ã€ŒDomainsã€ã‚’é¸æŠ
   - ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ï¼ˆä¾‹: `koekyan.com`ï¼‰

2. **DNSè¨­å®š**
   - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¸ã‚¹ãƒˆãƒ©ã§DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®š
   - VercelãŒæä¾›ã™ã‚‹DNSè¨­å®šã«å¾“ã†

3. **SSLè¨¼æ˜æ›¸**
   - VercelãŒè‡ªå‹•çš„ã«Let's Encryptè¨¼æ˜æ›¸ã‚’ç™ºè¡Œ
   - HTTPSãŒè‡ªå‹•çš„ã«æœ‰åŠ¹åŒ–

### 8.4 ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤

#### 8.4.1 ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ

- å„ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«è‡ªå‹•çš„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒä½œæˆ
- ç’°å¢ƒå¤‰æ•°ã¯æœ¬ç•ªç’°å¢ƒã¨åŒã˜ã‚‚ã®ã‚’ä½¿ç”¨ï¼ˆã¾ãŸã¯åˆ¥é€”è¨­å®šï¼‰

#### 8.4.2 ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ

1. **ãƒ–ãƒ©ãƒ³ãƒè¨­å®š**
   - ã€ŒSettingsã€â†’ã€ŒGitã€ã§ãƒ–ãƒ©ãƒ³ãƒã‚’è¨­å®š
   - ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ãƒ–ãƒ©ãƒ³ãƒ: `staging`

2. **ç’°å¢ƒå¤‰æ•°è¨­å®š**
   - ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
   - Supabaseã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®URLç­‰

#### 8.4.3 æœ¬ç•ªç’°å¢ƒ

- `main`ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
- æœ¬ç•ªç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨

### 8.5 ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª

#### 8.5.1 å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãŒå‹•ä½œã™ã‚‹
- [ ] Supabaseæ¥ç¶šãŒæ­£å¸¸
- [ ] ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒã‚¤ãƒ³ãƒˆäº¤æ›ãŒå‹•ä½œã™ã‚‹
- [ ] LINEé€£æºãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒå‹•ä½œã™ã‚‹
- [ ] ç®¡ç†è€…ç”»é¢ãŒå‹•ä½œã™ã‚‹

#### 8.5.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª

- [ ] Lighthouseã‚¹ã‚³ã‚¢ç¢ºèªï¼ˆ90ç‚¹ä»¥ä¸Šã‚’ç›®æ¨™ï¼‰
- [ ] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é€Ÿåº¦ï¼ˆ3ç§’ä»¥å†…ï¼‰
- [ ] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ï¼ˆ1ç§’ä»¥å†…ï¼‰

---

## 9. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 9.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

```python
# tests/test_point_exchange_service.py
import pytest
from unittest.mock import AsyncMock, patch
from app.services.point_exchange_service import PointExchangeService

@pytest.mark.asyncio
async def test_request_exchange_success():
    """ãƒã‚¤ãƒ³ãƒˆäº¤æ›ç”³è«‹ï¼ˆæˆåŠŸï¼‰"""
    service = PointExchangeService(
        api_url="https://test.example.com",
        api_key="test_key",
        api_secret="test_secret"
    )
    
    # ãƒ¢ãƒƒã‚¯è¨­å®š
    with patch.object(service.client, 'post', new=AsyncMock()) as mock_post:
        mock_post.return_value.status_code = 200
        mock_post.return_value.json.return_value = {
            'exchange_id': 'EX123456',
            'exchange_url': 'https://exchange.example.com/EX123456'
        }
        
        # å®Ÿè¡Œ
        result = await service.request_exchange(
            user_id=1,
            points=500,
            user_email='test@example.com'
        )
        
        # æ¤œè¨¼
        assert result['success'] is True
        assert result['exchange_id'] == 'EX123456'
        assert 'exchange_url' in result

@pytest.mark.asyncio
async def test_request_exchange_timeout():
    """ãƒã‚¤ãƒ³ãƒˆäº¤æ›ç”³è«‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰"""
    service = PointExchangeService(
        api_url="https://test.example.com",
        api_key="test_key",
        api_secret="test_secret"
    )
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ¢ãƒƒã‚¯
    with patch.object(service.client, 'post', side_effect=TimeoutError()):
        result = await service.request_exchange(
            user_id=1,
            points=500,
            user_email='test@example.com'
        )
        
        # æ¤œè¨¼
        assert result['success'] is False
        assert 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' in result['message']
```

---

### 9.2 çµ±åˆãƒ†ã‚¹ãƒˆ

```python
# tests/integration/test_point_exchange_flow.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

@pytest.mark.integration
def test_point_exchange_flow():
    """ãƒã‚¤ãƒ³ãƒˆäº¤æ›ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ"""
    
    # 1. ãƒ­ã‚°ã‚¤ãƒ³
    login_response = client.post('/api/auth/login', json={
        'email': 'test@example.com',
        'password': 'password123'
    })
    assert login_response.status_code == 200
    token = login_response.json()['access_token']
    
    # 2. ãƒã‚¤ãƒ³ãƒˆç¢ºèª
    points_response = client.get(
        '/api/points',
        headers={'Authorization': f'Bearer {token}'}
    )
    assert points_response.status_code == 200
    initial_points = points_response.json()['total_points']
    assert initial_points >= 500
    
    # 3. ãƒã‚¤ãƒ³ãƒˆäº¤æ›ç”³è«‹
    exchange_response = client.post(
        '/api/exchange/request',
        headers={'Authorization': f'Bearer {token}'},
        json={'points': 500}
    )
    assert exchange_response.status_code == 200
    exchange_data = exchange_response.json()
    assert exchange_data['success'] is True
    assert 'exchange_id' in exchange_data
    
    # 4. ãƒã‚¤ãƒ³ãƒˆæ¸›ç®—ç¢ºèª
    updated_points_response = client.get(
        '/api/points',
        headers={'Authorization': f'Bearer {token}'}
    )
    updated_points = updated_points_response.json()['total_points']
    assert updated_points == initial_points - 500
    
    # 5. äº¤æ›å±¥æ­´ç¢ºèª
    history_response = client.get(
        '/api/exchange/history',
        headers={'Authorization': f'Bearer {token}'}
    )
    assert history_response.status_code == 200
    history = history_response.json()
    assert len(history) > 0
    assert history[0]['points'] == 500
```

---

### 9.3 è² è·ãƒ†ã‚¹ãƒˆ

```python
# tests/load/locustfile.py
from locust import HttpUser, task, between

class PointExchangeUser(HttpUser):
    """ãƒã‚¤ãƒ³ãƒˆäº¤æ›ã®è² è·ãƒ†ã‚¹ãƒˆ"""
    
    wait_time = between(1, 3)
    
    def on_start(self):
        """ãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼‰"""
        response = self.client.post('/api/auth/login', json={
            'email': 'test@example.com',
            'password': 'password123'
        })
        self.token = response.json()['access_token']
    
    @task(3)
    def get_surveys(self):
        """ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§å–å¾—"""
        self.client.get(
            '/api/surveys',
            headers={'Authorization': f'Bearer {self.token}'}
        )
    
    @task(2)
    def get_points(self):
        """ãƒã‚¤ãƒ³ãƒˆç¢ºèª"""
        self.client.get(
            '/api/points',
            headers={'Authorization': f'Bearer {self.token}'}
        )
    
    @task(1)
    def exchange_points(self):
        """ãƒã‚¤ãƒ³ãƒˆäº¤æ›ï¼ˆä½é »åº¦ï¼‰"""
        self.client.post(
            '/api/exchange/request',
            headers={'Authorization': f'Bearer {self.token}'},
            json={'points': 500}
        )
```

**å®Ÿè¡Œæ–¹æ³•**:
```bash
# 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ç§’é–“10ãƒ¦ãƒ¼ã‚¶ãƒ¼ãšã¤å¢—åŠ 
locust -f tests/load/locustfile.py --users 100 --spawn-rate 10
```

---

## 10. ç§»è¡Œå®Ÿæ–½æ‰‹é †

### 10.1 ç§»è¡Œå‰æº–å‚™

#### 10.1.1 ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

```markdown
## ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ç’°å¢ƒæº–å‚™
- [ ] æœ¬ç•ªç’°å¢ƒã®æ§‹ç¯‰å®Œäº†
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆã¨ã‚¹ã‚­ãƒ¼ãƒé©ç”¨
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- [ ] ç’°å¢ƒå¤‰æ•°ã®è¨­å®šå®Œäº†
- [ ] å¤–éƒ¨APIé€£æºã®è¨­å®šå®Œäº†

### ãƒ‡ãƒ¼ã‚¿æº–å‚™
- [ ] ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿CSVã®æº–å‚™å®Œäº†
- [ ] FAQãƒ‡ãƒ¼ã‚¿JSONã®æº–å‚™å®Œäº†
- [ ] åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®æº–å‚™å®Œäº†
- [ ] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™å®Œäº†

### æ¤œè¨¼æº–å‚™
- [ ] ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æº–å‚™å®Œäº†
- [ ] ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã®æº–å‚™å®Œäº†
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®ç¢ºèªå®Œäº†

### é€£æºç¢ºèª
- [ ] ãƒã‚¤ãƒ³ãƒˆäº¤æ›APIæ¥ç¶šç¢ºèª
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šç¢ºèª
- [ ] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šç¢ºèª

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
- [ ] è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
```

---

### 10.2 ç§»è¡Œæ‰‹é †

#### 10.2.1 ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—æ‰‹é †

```bash
#!/bin/bash
# migration.sh - ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«åœæ­¢

echo "=========================================="
echo "å£°ã‚­ãƒ£ãƒ³ï¼ ãƒ‡ãƒ¼ã‚¿ç§»è¡Œé–‹å§‹"
echo "=========================================="

# ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
source .env.production

# ã‚¹ãƒ†ãƒƒãƒ—1: äº‹å‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
echo ""
echo "[ã‚¹ãƒ†ãƒƒãƒ—1] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—ä¸­..."
./scripts/backup.sh

# ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™ç¢ºèª
echo ""
echo "[ã‚¹ãƒ†ãƒƒãƒ—2] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª..."
python scripts/check_db_connection.py

# ã‚¹ãƒ†ãƒƒãƒ—3: ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
echo ""
echo "[ã‚¹ãƒ†ãƒƒãƒ—3] ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ä¸­..."
python scripts/import_all_masters.py data/masters $DATABASE_URL

# ã‚¹ãƒ†ãƒƒãƒ—4: åˆæœŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„æŠ•å…¥
echo ""
echo "[ã‚¹ãƒ†ãƒƒãƒ—4] åˆæœŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„æŠ•å…¥ä¸­..."
python scripts/import_initial_content.py data/content $DATABASE_URL

# ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
echo ""
echo "[ã‚¹ãƒ†ãƒƒãƒ—5] ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ä¸­..."
python scripts/validate_data.py $DATABASE_URL

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ“ ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼æˆåŠŸ"
else
    echo ""
    echo "âœ— ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å¤±æ•—"
    echo "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n)"
    read answer
    if [ "$answer" = "y" ]; then
        ./scripts/rollback.sh
    fi
    exit 1
fi

# ã‚¹ãƒ†ãƒƒãƒ—6: å¤–éƒ¨é€£æºç¢ºèª
echo ""
echo "[ã‚¹ãƒ†ãƒƒãƒ—6] å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºç¢ºèªä¸­..."
python scripts/check_external_services.py

# ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
echo ""
echo "ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã‹ï¼Ÿ (y/n)"
read answer
if [ "$answer" = "y" ]; then
    echo "ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥ä¸­..."
    python scripts/import_test_data.py
fi

echo ""
echo "=========================================="
echo "âœ“ ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Œäº†"
echo "=========================================="
```

---

### 10.3 ç§»è¡Œå¾Œç¢ºèª

#### 10.3.1 å‹•ä½œç¢ºèªæ‰‹é †

```markdown
## ç§»è¡Œå¾Œç¢ºèªæ‰‹é †

### 1. ãƒ‡ãƒ¼ã‚¿ç¢ºèª
- [ ] å¤§å­¦ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä»¶æ•°ç¢ºèª
- [ ] å­¦éƒ¨ãƒ»å­¦ç§‘ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä»¶æ•°ç¢ºèª
- [ ] éƒ½é“åºœçœŒãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆ47ä»¶ï¼‰ç¢ºèª
- [ ] FAQãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºç¢ºèª
- [ ] åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®è¡¨ç¤ºç¢ºèª

### 2. æ©Ÿèƒ½ç¢ºèª
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½
- [ ] ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
- [ ] ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤º
- [ ] ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”æ©Ÿèƒ½
- [ ] ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºæ©Ÿèƒ½
- [ ] ãƒã‚¤ãƒ³ãƒˆäº¤æ›æ©Ÿèƒ½
- [ ] å‹é”ç´¹ä»‹æ©Ÿèƒ½

### 3. å¤–éƒ¨é€£æºç¢ºèª
- [ ] ãƒã‚¤ãƒ³ãƒˆäº¤æ›APIå‹•ä½œç¢ºèª
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ç¢ºèªï¼ˆä¼šå“¡ç™»éŒ²ï¼‰
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ç¢ºèªï¼ˆãƒã‚¤ãƒ³ãƒˆäº¤æ›ï¼‰
- [ ] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ç›£è¦–ç¢ºèªï¼ˆSentryï¼‰

### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
- [ ] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é€Ÿåº¦
- [ ] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªé€Ÿåº¦

### 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª
- [ ] HTTPSæ¥ç¶šç¢ºèª
- [ ] èªè¨¼æ©Ÿèƒ½ç¢ºèª
- [ ] æ¨©é™åˆ¶å¾¡ç¢ºèª
- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ç¢ºèª
- [ ] XSSå¯¾ç­–ç¢ºèª
```

---

### 10.4 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### 10.4.1 ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

| å•é¡Œ | åŸå›  | å¯¾å‡¦æ³• |
|------|------|--------|
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ | æ¥ç¶šæƒ…å ±ã®èª¤ã‚Š | ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª |
| ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å¤±æ•— | CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸æ­£ | CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ |
| å¤–éƒ¨APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ | APIã‚­ãƒ¼ã®èª¤ã‚Š | APIã‚­ãƒ¼ã‚’ç¢ºèª |
| ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•— | SMTPè¨­å®šèª¤ã‚Š | SMTPè¨­å®šã‚’ç¢ºèª |
| æ–‡å­—åŒ–ã‘ | ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸ä¸€è‡´ | UTF-8ã«çµ±ä¸€ |

#### 10.4.2 ãƒ­ã‚°ç¢ºèªã‚³ãƒãƒ³ãƒ‰

```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°
tail -f logs/app.log

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ã‚°
tail -f /var/log/postgresql/postgresql.log

# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿æŠ½å‡º
grep ERROR logs/app.log

# ç‰¹å®šæœŸé–“ã®ãƒ­ã‚°
grep "2025-11-22" logs/app.log
```

---

## ä»˜éŒ²

### A. ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼

#### A.1 å¤§å­¦ãƒã‚¹ã‚¿ãƒ¼CSVå½¢å¼

```csv
id,name,name_kana,prefecture_id,category
1,æ±äº¬å¤§å­¦,ã¨ã†ãã‚‡ã†ã ã„ãŒã,13,å›½ç«‹
2,äº¬éƒ½å¤§å­¦,ãã‚‡ã†ã¨ã ã„ãŒã,26,å›½ç«‹
...
```

#### A.2 FAQ JSONå½¢å¼

```json
[
  {
    "category": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ç™»éŒ²",
    "question": "è³ªå•å†…å®¹",
    "answer": "å›ç­”å†…å®¹",
    "display_order": 1,
    "is_published": true
  }
]
```

---

### B. APIä»•æ§˜æ›¸ï¼ˆå¤–éƒ¨é€£æºï¼‰

#### B.1 ãƒã‚¤ãƒ³ãƒˆäº¤æ›API

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/exchange/request`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "api_key": "your_api_key",
  "user_id": "123",
  "points": 500,
  "email": "user@example.com",
  "timestamp": 1700000000,
  "signature": "calculated_signature"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸï¼‰**:
```json
{
  "success": true,
  "exchange_id": "EX123456789",
  "exchange_url": "https://exchange.example.com/EX123456789",
  "expires_at": "2025-12-31T23:59:59Z"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰**:
```json
{
  "success": false,
  "error_code": "INSUFFICIENT_POINTS",
  "message": "ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™"
}
```

---

### C. ç§»è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾‹

| æ—¥ç¨‹ | ä½œæ¥­å†…å®¹ | æ‹…å½“ | æ‰€è¦æ™‚é–“ |
|------|----------|------|----------|
| D-7 | ç§»è¡Œè¨ˆç”»æœ€çµ‚ç¢ºèª | å…¨å“¡ | 2æ™‚é–“ |
| D-5 | ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒªãƒãƒ¼ã‚µãƒ« | ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… | 4æ™‚é–“ |
| D-3 | æœ¬ç•ªç’°å¢ƒæº–å‚™ | ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… | 2æ™‚é–“ |
| D-1 | æœ€çµ‚ç¢ºèª | å…¨å“¡ | 1æ™‚é–“ |
| D-Day | æœ¬ç•ªç§»è¡Œå®Ÿæ–½ | ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… | 3æ™‚é–“ |
| D+1 | ç§»è¡Œå¾Œç¢ºèª | å…¨å“¡ | 2æ™‚é–“ |

---

**æ–‡æ›¸ä½œæˆæ—¥**: 2025å¹´11æœˆ22æ—¥  
**æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´11æœˆ22æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0  
**ä½œæˆè€…**: Claude  
**æ‰¿èªè€…**: ï¼ˆæ‰¿èªäºˆå®šï¼‰  
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼äºˆå®š**: ç§»è¡Œå®Œäº†å¾Œ

---

## ä»˜éŒ²D. v2.0æ§‹ç¯‰æ‰‹é †ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### D.1 æ§‹ç¯‰é †åº

1. **Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³2.1ï¼‰
2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³2.2ï¼‰
3. **RLSãƒãƒªã‚·ãƒ¼è¨­å®š**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼‰
4. **Database Functionsä½œæˆ**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³4ï¼‰
5. **åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³5ï¼‰
6. **å¤–éƒ¨APIé€£æºè¨­å®š**
   - ãƒã‚¤ãƒ³ãƒˆäº¤æ›APIï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³6.1ï¼‰
   - LINE Messaging APIï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³6.3ï¼‰
   - Firebase Cloud Messagingï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³6.4ï¼‰
   - ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆSendGrid/Resendï¼‰
7. **Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³8.1ï¼‰
8. **Vercelãƒ‡ãƒ—ãƒ­ã‚¤**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³8.2-8.3ï¼‰

### D.2 å¿…é ˆç’°å¢ƒå¤‰æ•°ä¸€è¦§

**Supabase**:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

**LINE**:
- `LINE_CHANNEL_ID`
- `LINE_CHANNEL_SECRET`
- `LINE_CHANNEL_ACCESS_TOKEN`

**Firebase**:
- `NEXT_PUBLIC_FIREBASE_API_KEY`
- `NEXT_PUBLIC_FIREBASE_PROJECT_ID`
- `NEXT_PUBLIC_FIREBASE_VAPID_KEY`
- `FIREBASE_CLIENT_EMAIL`
- `FIREBASE_PRIVATE_KEY`

**ãƒã‚¤ãƒ³ãƒˆäº¤æ›API**:
- `POINT_EXCHANGE_API_URL`
- `POINT_EXCHANGE_API_KEY`
- `POINT_EXCHANGE_API_SECRET`

**ãƒ¡ãƒ¼ãƒ«é€ä¿¡**:
- `SENDGRID_API_KEY`
- `SENDGRID_FROM_EMAIL`

### D.3 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

| å•é¡Œ | ç¢ºèªé …ç›® | è§£æ±ºæ–¹æ³• |
|------|----------|----------|
| Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼ | ç’°å¢ƒå¤‰æ•°ã€RLSãƒãƒªã‚·ãƒ¼ | ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã€RLSãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèª |
| LINEé€šçŸ¥ãŒé€ä¿¡ã•ã‚Œãªã„ | Channel Access Tokenã€Webhook URL | ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ç¢ºèªã€Webhook URLæ¤œè¨¼ |
| ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒå‹•ä½œã—ãªã„ | Service Workerã€VAPIDéµ | Service Workerç™»éŒ²ç¢ºèªã€VAPIDéµç¢ºèª |
| ãƒã‚¤ãƒ³ãƒˆäº¤æ›ãŒå¤±æ•—ã™ã‚‹ | APIã‚­ãƒ¼ã€ç½²å | APIã‚­ãƒ¼ç¢ºèªã€ç½²åç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª |
| Vercelãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼ | ç’°å¢ƒå¤‰æ•°ã€ãƒ“ãƒ«ãƒ‰ãƒ­ã‚° | ç’°å¢ƒå¤‰æ•°è¨­å®šç¢ºèªã€ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèª |