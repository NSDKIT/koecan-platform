# 声キャン！ 運用設計書 v2.0

## 改訂履歴
| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0 | 2025-11-22 | 初版作成 | Claude |
| 2.0 | 2025-11-22 | v2.0機能追加、実装状況を反映 | Claude |

## v2.0での主な変更点
- ✅ 友達紹介機能の運用手順を追加
- ✅ FAQ管理の運用フローを追加
- ✅ お知らせ配信の運用手順を追加
- ✅ ブラウザプッシュ通知の運用を追加
- ✅ LINE連携の運用手順を詳細化
- ✅ 外部API連携（ポイント交換）の自動化運用を追加
- ✅ Supabaseベースの監視・運用に変更
- ✅ 不正利用防止の運用を強化

---

## 目次
1. [運用体制](#1-運用体制)
2. [監視運用](#2-監視運用)
3. [障害対応](#3-障害対応)
4. [バックアップ・リストア](#4-バックアップリストア)
5. [セキュリティ運用](#5-セキュリティ運用)
6. [アンケート運用](#6-アンケート運用)
7. [ポイント交換運用](#7-ポイント交換運用)
8. [友達紹介運用](#8-友達紹介運用)
9. [FAQ・お知らせ運用](#9-faqお知らせ運用)
10. [通知運用](#10-通知運用)
11. [ユーザーサポート](#11-ユーザーサポート)
12. [データ管理](#12-データ管理)
13. [リリース管理](#13-リリース管理)
14. [パフォーマンス管理](#14-パフォーマンス管理)
15. [コスト管理](#15-コスト管理)
16. [定期メンテナンス](#16-定期メンテナンス)

---

## 1. 運用体制

### 1.1 運用チーム構成

#### 1.1.1 推奨体制（v2.0）
```
運用責任者 × 1名
├─ システム管理者 × 1-2名
│  ├─ Supabaseインフラ管理
│  ├─ 外部API連携管理（ポイント交換、LINE等）
│  ├─ 障害対応
│  └─ セキュリティ管理
│
├─ コンテンツ管理者 × 1-2名
│  ├─ アンケート作成・公開
│  ├─ FAQ管理
│  ├─ お知らせ配信
│  ├─ 企業対応
│  └─ プッシュ通知送信
│
└─ カスタマーサポート × 1-2名
   ├─ 問い合わせ対応
   ├─ チャットサポート
   ├─ 友達紹介の不正監視
   ├─ FAQ更新
   └─ ユーザーフィードバック収集
```

#### 1.1.2 役割と責任（v2.0更新）

**運用責任者**
- 運用全体の統括
- 重大障害時の意思決定
- 運用方針の策定
- KPIモニタリング
- 外部ベンダーマネジメント（ポイント交換API、LINE等）

**システム管理者**
- Supabaseプロジェクトの管理
- RLSポリシーの設定・更新
- 外部API連携の監視（ポイント交換、LINE、メール送信）
- 障害検知と一次対応
- バックアップ管理
- セキュリティパッチ適用
- パフォーマンスチューニング
- ログ分析
- プッシュ通知システムの管理

**コンテンツ管理者**
- アンケートの作成・編集・公開
- 企業からの依頼対応
- アンケート配信スケジュール管理
- 回答データの品質チェック
- **FAQ の作成・更新** 🆕
- **お知らせの作成・配信** 🆕
- **プッシュ通知の送信** 🆕
- キャンペーン企画・実施

**カスタマーサポート**
- ユーザーからの問い合わせ対応（メール、チャット）
- FAQ作成・更新支援
- 不具合報告の受付・エスカレーション
- ユーザーフィードバックの収集
- サポートドキュメント作成
- **友達紹介の不正利用監視** 🆕
- **LINE連携サポート** 🆕

### 1.2 運用時間

#### 1.2.1 サービス提供時間
- **基本**: 24時間365日稼働
- **定期メンテナンス**: 月1回、深夜時間帯（3:00-5:00）

#### 1.2.2 サポート対応時間
- **平日**: 10:00-18:00
- **土日祝**: 対応なし（緊急時を除く）
- **問い合わせ方法**: 
  - メール（support@koekyan.example.com）
  - アプリ内問い合わせフォーム
  - **チャット**（MonitorDashboard経由） 🆕

#### 1.2.3 オンコール体制
- **平日夜間・休日**: システム管理者がオンコール待機
- **緊急連絡**: Slack、電話、SMS
- **対象**: レベル1（致命的）、レベル2（重大）の障害のみ

---

## 2. 監視運用

### 2.1 監視項目（v2.0更新）

#### 2.1.1 Supabaseインフラ監視
**Supabase Dashboard**
- データベース接続数（閾値: 警告80%, 危険95%）
- データベースサイズ（閾値: 警告80%, 危険90%）
- APIリクエスト数（月間上限の監視）
- Realtime接続数
- Storage使用量

**認証**
- アクティブユーザー数
- 認証エラー率
- 不正ログイン試行

#### 2.1.2 アプリケーション監視
**稼働監視**
- アプリケーションのレスポンスタイム（閾値: 警告3秒, 危険5秒）
- エラーログの監視（Sentry経由）
- APIエンドポイントの稼働状況

**トランザクション監視**
- ユーザー登録処理
- アンケート回答処理
- ポイント付与処理
- **ポイント交換処理（外部API連携）** 🆕
- **友達紹介処理** 🆕

**外部API監視** 🆕
- **ポイント交換API**
  - レスポンスタイム
  - エラー率
  - 交換成功率
- **LINE Messaging API**
  - メッセージ送信成功率
  - API制限（月間メッセージ数）
- **メール送信サービス**
  - 送信成功率
  - バウンス率
- **プッシュ通知サービス**
  - 送信成功率
  - サブスクリプション数

#### 2.1.3 データベース監視（Supabase）
- テーブルサイズ
- インデックス効率
- スロークエリ（3秒以上）
- RLSポリシーの適用状況

#### 2.1.4 セキュリティ監視
- 不正ログイン試行（5分間に5回以上）
- 異常なAPIアクセス
- **友達紹介の不正利用パターン** 🆕
  - 同一IPからの大量登録
  - 短時間での大量紹介
  - 不自然な登録パターン
- RLSポリシー違反の試行
- 管理者権限での操作ログ

#### 2.1.5 ビジネス監視
- ユーザー登録数（日次）
- アクティブユーザー数（日次）
- アンケート回答数（時間別）
- ポイント交換申請数
- **友達紹介成功数** 🆕
- **LINE連携率** 🆕
- **プッシュ通知許可率** 🆕
- **PWAインストール数** 🆕
- **FAQ閲覧数** 🆕
- エラー発生率

### 2.2 監視ツール

#### 2.2.1 推奨ツール（v2.0）
**Supabase標準機能**
- Supabase Dashboard（基本監視）
- Supabase Logs（ログ確認）
- Supabase API Analytics

**追加監視ツール**
- **Sentry**: エラー追跡、パフォーマンス監視
- **Google Analytics 4**: ユーザー行動分析
- **UptimeRobot**: 外形監視（稼働監視）
- **Slack**: アラート通知

**カスタムダッシュボード**（オプション）
- Grafana + Prometheus（詳細監視が必要な場合）
- Datadog（統合監視プラットフォーム）

### 2.3 アラート設定（v2.0更新）

#### 2.3.1 アラートレベル
| レベル | 説明 | 通知先 | 対応時間 |
|--------|------|--------|----------|
| レベル1（致命的） | サービス停止、外部API完全障害 | 運用責任者、システム管理者（即時） | 即時対応 |
| レベル2（重大） | 一部機能停止、外部API部分障害 | システム管理者（即時） | 30分以内 |
| レベル3（警告） | リソース高負荷、API エラー率上昇 | システム管理者（メール） | 営業時間内 |
| レベル4（情報） | 軽微な異常、予兆 | ログのみ | 定期確認 |

#### 2.3.2 主要アラート設定例（v2.0）

**Supabase関連**:
```yaml
# データベース接続上限
alert: DatabaseConnectionLimit
condition: db_connections > 80 for 5 minutes
severity: Level2
action: Slack通知

# APIレート制限接近
alert: APIRateLimitApproaching
condition: api_requests > 80% of monthly limit
severity: Level3
action: Slack通知、メール通知
```

**外部API関連** 🆕:
```yaml
# ポイント交換API障害
alert: PointExchangeAPIError
condition: exchange_api_error_rate > 50% for 3 minutes
severity: Level1
action: 即時通知（Slack + 電話）、フォールバック起動

# LINE API障害
alert: LineAPIError
condition: line_message_error_rate > 30% for 5 minutes
severity: Level2
action: Slack通知、メールフォールバック起動

# メール送信エラー
alert: EmailSendError
condition: email_error_rate > 20% for 5 minutes
severity: Level2
action: Slack通知

# プッシュ通知エラー
alert: PushNotificationError
condition: push_notification_error_rate > 30% for 5 minutes
severity: Level3
action: Slack通知
```

**セキュリティ関連** 🆕:
```yaml
# 友達紹介不正検知
alert: ReferralFraudDetected
condition: same_ip_registrations > 5 in 1 hour
severity: Level2
action: Slack通知、自動審査フラグ

# 不正ログイン試行
alert: BruteForceAttack
condition: failed_login_attempts > 5 from same_ip in 5 minutes
severity: Level3
action: Slack通知 + IPブロック
```

### 2.4 ダッシュボード（v2.0更新）

#### 2.4.1 リアルタイムダッシュボード
**システムダッシュボード**
- Supabase稼働状況
- データベース接続数・サイズ
- APIリクエスト数
- エラー発生状況
- 外部API稼働状況（ポイント交換、LINE、メール）

**ビジネスダッシュボード**
- 現在のアクティブユーザー数
- 本日の登録ユーザー数
- 本日のアンケート回答数
- 本日のポイント交換申請数
- **本日の友達紹介成功数** 🆕
- **LINE連携数** 🆕
- **プッシュ通知購読数** 🆕
- アクセス数の推移（時系列）

#### 2.4.2 定期レポート（v2.0更新）

**日次レポート**（毎朝9:00自動送信）
- 前日のユーザー登録数
- 前日のアクティブユーザー数
- 前日のアンケート回答数
- 前日のポイント発行数
- **前日の友達紹介成功数** 🆕
- **LINE連携数（累計・増分）** 🆕
- 前日のエラー発生件数
- 外部API使用状況

**週次レポート**（毎週月曜9:00自動送信）
- 週次のKPI推移
- 人気アンケートランキング
- ユーザーエンゲージメント指標
- **友達紹介ランキング** 🆕
- **FAQ閲覧ランキング** 🆕
- システムパフォーマンス概況
- 外部APIコスト

**月次レポート**（毎月1日9:00自動送信）
- 月次KPIサマリー
- ユーザー成長率
- アンケート回答率推移
- ポイント発行・交換状況
- **友達紹介による新規獲得率** 🆕
- **通知配信状況（LINE/プッシュ/メール）** 🆕
- インフラコスト（Supabase、外部API）
- 障害発生状況

---

## 3. 障害対応

### 3.1 障害レベル定義（v2.0更新）

| レベル | 影響範囲 | 例 | 対応目標時間 |
|--------|----------|-----|--------------|
| レベル1（致命的） | 全ユーザーに影響、サービス停止 | Supabase障害、全外部API障害 | 復旧：1時間以内 |
| レベル2（重大） | 多数のユーザーに影響、主要機能停止 | ログイン不可、ポイント交換API障害 | 復旧：4時間以内 |
| レベル3（中程度） | 一部ユーザーに影響、機能制限 | 特定画面エラー、通知遅延 | 復旧：1営業日以内 |
| レベル4（軽微） | 限定的な影響、代替手段あり | 表示崩れ、軽微なバグ | 修正：1週間以内 |

### 3.2 障害対応フロー（v2.0）

#### 3.2.1 基本フロー
```
1. 障害検知（監視ツール/ユーザー報告）
   ↓
2. 初動対応（影響範囲の確認）
   ↓
3. エスカレーション判断
   ↓
4. 原因調査
   ├─ Supabaseログ確認
   ├─ 外部APIステータス確認
   └─ エラーログ（Sentry）確認
   ↓
5. 復旧作業
   ├─ 暫定対応（フォールバック起動）
   └─ 根本対応
   ↓
6. 復旧確認
   ↓
7. ユーザー通知（お知らせ/LINE/プッシュ/メール）
   ↓
8. 事後報告・振り返り
```

### 3.3 主要障害シナリオと対応（v2.0更新）

#### 3.3.1 Supabase障害
**症状**: データベース接続エラー、認証エラー

**対応手順**:
1. Supabase Statusページで障害情報確認
2. Supabaseサポートに連絡
3. ユーザーに障害情報を通知（お知らせバナー）
4. 復旧後、データ整合性確認

**予防策**:
- 重要なデータは定期バックアップ
- 将来的に Multi-Region構成を検討

#### 3.3.2 ポイント交換API障害 🆕
**症状**: ポイント交換ができない

**対応手順**:
1. 外部API側の障害情報確認（ステータスページ、サポート）
2. **自動フォールバック起動**: 手動承認モードに切り替え
   ```sql
   UPDATE system_settings 
   SET point_exchange_mode = 'manual' 
   WHERE key = 'exchange_mode';
   ```
3. ユーザーに状況を通知
   - 「現在、ポイント交換に一時的な遅延が発生しています」
4. 手動承認で交換処理を継続
5. 外部API復旧後、自動モードに戻す
6. 滞留していた申請を自動処理

**予防策**:
- 複数のポイント交換サービスと契約（優先順位付け）
- タイムアウト・リトライ設定の最適化

#### 3.3.3 LINE API障害 🆕
**症状**: LINE通知が送信できない

**対応手順**:
1. LINE Developers コンソールで確認
2. **メールフォールバック起動**
   - LINE連携ユーザーにもメールで通知
3. ユーザーに状況を通知
4. LINE API復旧後、通常運用に戻す

**予防策**:
- メール通知を常に併用（重要な通知）
- LINEメッセージ送信前にAPIステータス確認

#### 3.3.4 プッシュ通知障害 🆕
**症状**: ブラウザプッシュ通知が送信されない

**対応手順**:
1. Service Workerのエラー確認
2. FCMステータス確認
3. 影響範囲の特定（特定ブラウザのみ等）
4. LINEまたはメールで代替通知
5. 原因調査と修正

**予防策**:
- 複数の通知手段を併用
- ブラウザ別の動作確認を定期実施

#### 3.3.5 友達紹介の不正利用 🆕
**症状**: 同一IPから大量の新規登録

**対応手順**:
1. 自動検知システムが該当ユーザーにフラグを立てる
2. 手動で登録パターンを調査
   - IPアドレス
   - User Agent
   - 登録時刻
   - 紹介コード利用パターン
3. 不正と判断した場合
   - 該当アカウントを停止
   - 紹介報酬ポイントを取り消し
   - 紹介者に警告通知
4. 悪質な場合はアカウント削除

**予防策**:
- CAPTCHA導入
- デバイスフィンガープリンティング
- 紹介人数の上限設定（例: 月10人まで）

---

## 4. バックアップ・リストア

### 4.1 バックアップ戦略（v2.0: Supabase準拠）

#### 4.1.1 Supabase標準バックアップ
**自動バックアップ**（Supabase Proプラン以上）:
- **頻度**: 日次（深夜2:00 UTC）
- **保持期間**: 7日間
- **対象**: データベース全体
- **方式**: Point-in-Time Recovery (PITR) 対応

**手動バックアップ**（推奨追加運用）:
- **頻度**: 週次（日曜深夜）
- **保持期間**: 4週間
- **対象**: データベース全体
- **保存先**: 外部ストレージ（AWS S3/Google Cloud Storage）

#### 4.1.2 バックアップ対象データ

| データ種別 | バックアップ頻度 | 保持期間 | 保存先 |
|------------|------------------|----------|--------|
| データベース全体 | 日次（Supabase自動） | 7日間 | Supabase内部 |
| データベース全体 | 週次（手動） | 4週間 | 外部ストレージ |
| 重要テーブル | 変更前 | 30日間 | 外部ストレージ |
| Storage（画像等） | 週次 | 4週間 | 外部ストレージ |
| 設定ファイル | 変更時 | 無期限 | Git リポジトリ |

#### 4.1.3 バックアップ手順

**週次手動バックアップ**:
```bash
#!/bin/bash
# weekly_backup.sh

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="backups/weekly_${TIMESTAMP}"
SUPABASE_DB_URL="your_supabase_connection_string"

mkdir -p ${BACKUP_DIR}

# データベースダンプ
pg_dump ${SUPABASE_DB_URL} -F c -f ${BACKUP_DIR}/db_backup.dump

# 圧縮
tar -czf ${BACKUP_DIR}.tar.gz ${BACKUP_DIR}

# S3にアップロード
aws s3 cp ${BACKUP_DIR}.tar.gz s3://koekyan-backups/weekly/

# ローカルファイル削除（7日以上前）
find backups/weekly_* -type d -mtime +7 -exec rm -rf {} \;

echo "週次バックアップ完了: ${BACKUP_DIR}.tar.gz"
```

**重要テーブルのスナップショット**（大規模変更前）:
```sql
-- ポイント交換方式変更前など
CREATE TABLE point_exchange_requests_backup_20251122 
AS SELECT * FROM point_exchange_requests;
```

### 4.2 リストア手順

#### 4.2.1 Supabase PITRによるリストア
**手順**:
1. Supabase Dashboard → Database → Backups
2. リストアポイントを選択（過去7日以内）
3. "Restore" をクリック
4. 新しいプロジェクトとしてリストア（本番に影響しない）
5. データ検証後、本番に反映

#### 4.2.2 手動バックアップからのリストア
```bash
#!/bin/bash
# restore_from_backup.sh

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
  echo "使い方: ./restore_from_backup.sh <BACKUP_FILE>"
  exit 1
fi

# S3からダウンロード
aws s3 cp s3://koekyan-backups/weekly/${BACKUP_FILE} .

# 解凍
tar -xzf ${BACKUP_FILE}

# リストア（事前にメンテナンスモードON推奨）
pg_restore -h your_supabase_host -U postgres -d postgres \
  --clean --if-exists \
  ${BACKUP_DIR}/db_backup.dump

echo "リストア完了"
```

#### 4.2.3 リストアテスト
- **頻度**: 月1回
- **内容**: ステージング環境へリストア
- **確認項目**:
  - データ整合性
  - アプリケーション動作
  - RLSポリシーの適用状況

---

## 5. セキュリティ運用

### 5.1 アクセス管理（v2.0: Supabase準拠）

#### 5.1.1 Supabaseアクセス権限
**プロジェクト管理**:
- Owner（運用責任者）: 全権限
- Admin（システム管理者）: 管理権限
- Developer（開発者）: 読み取り専用（本番環境）

**データベースアクセス**:
- 直接SQL実行は最小限に制限
- RLS（Row Level Security）ポリシーで制御
- アプリケーションからはSupabase Client経由のみ

#### 5.1.2 Row Level Security (RLS) ポリシー 🆕

**users テーブル**:
```sql
-- ユーザーは自分のレコードのみ参照可能
CREATE POLICY "Users can view own data"
ON users FOR SELECT
USING (auth.uid() = id);

-- ユーザーは自分のレコードのみ更新可能
CREATE POLICY "Users can update own data"
ON users FOR UPDATE
USING (auth.uid() = id);
```

**monitor_profiles テーブル**:
```sql
-- ユーザーは自分のプロフィールのみ参照・更新可能
CREATE POLICY "Users can manage own profile"
ON monitor_profiles
USING (auth.uid() = user_id);
```

**survey_responses テーブル**:
```sql
-- ユーザーは自分の回答のみ挿入可能
CREATE POLICY "Users can insert own responses"
ON survey_responses FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- クライアントは自社アンケートの回答のみ参照可能
CREATE POLICY "Clients can view own survey responses"
ON survey_responses FOR SELECT
USING (
  survey_id IN (
    SELECT id FROM surveys WHERE client_id = auth.uid()
  )
);

-- 管理者は全て参照可能
CREATE POLICY "Admins can view all responses"
ON survey_responses FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM users WHERE id = auth.uid() AND role = 'admin'
  )
);
```

**point_history テーブル**:
```sql
-- ユーザーは自分の履歴のみ参照可能
CREATE POLICY "Users can view own point history"
ON point_history FOR SELECT
USING (auth.uid() = user_id);

-- 挿入はバックエンド関数のみ（RPC経由）
CREATE POLICY "Only backend can insert points"
ON point_history FOR INSERT
WITH CHECK (false); -- 直接挿入は禁止
```

**referral_codes テーブル** 🆕:
```sql
-- ユーザーは自分の紹介コードのみ参照可能
CREATE POLICY "Users can view own referral code"
ON referral_codes FOR SELECT
USING (auth.uid() = user_id);

-- 挿入もバックエンド関数経由
CREATE POLICY "Only backend can create referral codes"
ON referral_codes FOR INSERT
WITH CHECK (false);
```

#### 5.1.3 権限レビュー
- **頻度**: 四半期ごと
- **内容**: 
  - Supabaseプロジェクトメンバーの棚卸し
  - RLSポリシーの妥当性確認
  - 不要なアカウントの削除
  - 退職者のアクセス即時削除

### 5.2 脆弱性管理

#### 5.2.1 脆弱性スキャン
**自動スキャン**:
- **頻度**: 週次
- **ツール**: 
  - Dependabot（GitHub）: npm依存関係
  - Snyk: フロントエンド脆弱性
- **対象**: フロントエンドライブラリ、依存関係

**手動診断**:
- **頻度**: 年2回
- **外部セキュリティベンダー**による診断
- ペネトレーションテスト

#### 5.2.2 パッチ適用
**緊急パッチ（Critical）**:
- **適用期限**: 発見後24時間以内
- **対象**: リモートコード実行、SQLインジェクションなど

**重要パッチ（High）**:
- **適用期限**: 発見後1週間以内
- **対象**: XSS、認証バイパスなど

**通常パッチ（Medium/Low）**:
- **適用期限**: 次回定期メンテナンス時
- **対象**: その他の脆弱性

### 5.3 ログ管理（v2.0: Supabase準拠）

#### 5.3.1 ログ収集
**Supabase Logs**:
- API Logs（APIリクエスト）
- Postgres Logs（データベースクエリ）
- Realtime Logs（リアルタイム通信）
- Auth Logs（認証ログ）

**アプリケーションログ**（Sentry）:
- エラーログ
- パフォーマンスログ
- ユーザー行動ログ

**外部APIログ** 🆕:
- ポイント交換API呼び出しログ
- LINE APIコールログ
- メール送信ログ
- プッシュ通知送信ログ

#### 5.3.2 ログ分析
**定期分析**:
- **頻度**: 日次
- **内容**: 
  - 異常なアクセスパターンの検出
  - 不正ログイン試行の確認
  - エラー頻度の分析
  - **友達紹介の不正パターン検出** 🆕

**リアルタイム検知**:
- 不正ログイン試行（5分間に5回以上）
- 管理者権限での操作
- 大量データダウンロード
- **同一IPからの大量登録** 🆕

### 5.4 データプライバシー（v2.0更新）

#### 5.4.1 個人情報保護
**暗号化**:
- **通信**: TLS 1.3（Supabase標準）
- **保存**: Supabase暗号化ストレージ
- **パスワード**: bcrypt（Supabase Auth標準）

**アクセス制限**:
- RLSポリシーによる行レベルセキュリティ
- 個人情報へのアクセスログ記録
- 最小権限の原則

#### 5.4.2 データ削除（GDPR対応）
**ユーザー退会時**:
```sql
-- ユーザーデータの匿名化（退会後1年経過時）
CREATE FUNCTION anonymize_user_data(target_user_id UUID) 
RETURNS void AS $$
BEGIN
  -- ユーザー情報を匿名化
  UPDATE users SET
    name = 'Anonymous User',
    email = 'deleted_' || target_user_id || '@example.com'
  WHERE id = target_user_id;
  
  -- プロフィール削除
  DELETE FROM monitor_profiles WHERE user_id = target_user_id;
  DELETE FROM monitor_profile_survey WHERE user_id = target_user_id;
  
  -- LINE連携削除
  DELETE FROM line_connections WHERE user_id = target_user_id;
  
  -- プッシュ通知購読削除
  DELETE FROM push_subscriptions WHERE user_id = target_user_id;
  
  -- チャット履歴削除
  DELETE FROM chat_messages WHERE sender_id = target_user_id;
  
  -- アンケート回答は統計用に保持（user_idは匿名化済み）
END;
$$ LANGUAGE plpgsql;
```

**データエクスポート**（GDPR Article 20）:
```typescript
// ユーザーデータのエクスポート機能
async function exportUserData(userId: string) {
  const { data, error } = await supabase.rpc('export_user_data', {
    p_user_id: userId
  });
  
  if (error) throw error;
  
  // JSON形式でダウンロード
  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: 'application/json'
  });
  downloadBlob(blob, `user_data_${userId}.json`);
}
```

---

## 6. アンケート運用

### 6.1 アンケート作成フロー（v2.0更新）

#### 6.1.1 企業からの依頼受付
```
1. 企業から依頼受付（メール/問い合わせフォーム）
   ↓
2. ヒアリング（目的、対象者、質問内容、期限）
   ↓
3. 見積もり提示・契約
   ↓
4. アンケート作成
   ├─ 手動作成（ClientDashboard）
   ├─ Markdownインポート（ImportSurveyModal） 🆕
   └─ CSVインポート（ImportCsvModal） 🆕
   ↓
5. プレビュー・テスト回答
   ↓
6. 企業確認・修正
   ↓
7. 最終承認
   ↓
8. 配信予約設定
   ↓
9. 公開・配信
   ├─ **お知らせで告知** 🆕
   ├─ **LINE通知送信** 🆕
   └─ **プッシュ通知送信** 🆕
```

#### 6.1.2 Markdownインポートの運用 🆕
**メリット**:
- 複数のアンケートを一度に作成可能
- テキストエディタで効率的に編集
- バージョン管理が容易（Git）

**運用フロー**:
1. テンプレートをダウンロード
2. Markdownエディタで作成
3. ImportSurveyModalからアップロード
4. プレビューで確認
5. 一括インポート

**注意点**:
- インポート前に必ずプレビュー確認
- エラーがある場合は修正して再アップロード

### 6.2 アンケート公開管理（v2.0更新）

#### 6.2.1 公開前チェックリスト
- [ ] 質問内容の妥当性確認
- [ ] 誤字脱字チェック
- [ ] 選択肢の網羅性確認
- [ ] 獲得ポイント数の設定確認
- [ ] 対象者条件の設定確認
- [ ] 公開期間の設定確認
- [ ] テスト回答の実施
- [ ] 企業の最終承認取得
- [ ] **通知文の作成（LINE/プッシュ/お知らせ）** 🆕

#### 6.2.2 公開時の通知 🆕
**お知らせバナー**:
```typescript
// お知らせ作成
await supabase.from('announcements').insert({
  title: '新しいアンケートが追加されました',
  content: '「就活に関するアンケート」に回答して30ptゲット！',
  announcement_type: 'news',
  target_roles: ['monitor'],
  is_published: true
});
```

**LINE通知**:
```typescript
// LINE連携ユーザーに通知
const { data: lineUsers } = await supabase
  .from('line_connections')
  .select('line_user_id, users!inner(role)')
  .eq('users.role', 'monitor');

for (const user of lineUsers) {
  await sendLineMessage(user.line_user_id, {
    type: 'flex',
    altText: '新しいアンケート追加',
    contents: {
      type: 'bubble',
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          { type: 'text', text: '新しいアンケート📝', weight: 'bold' },
          { type: 'text', text: '「就活に関するアンケート」' },
          { type: 'text', text: '報酬: 30pt 🎁' }
        ]
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'button',
            action: { type: 'uri', label: '回答する', uri: 'https://app.koekyan.jp/surveys/123' },
            style: 'primary'
          }
        ]
      }
    }
  });
}
```

**ブラウザプッシュ通知**:
```typescript
// プッシュ通知購読者に送信
const { data: subscriptions } = await supabase
  .from('push_subscriptions')
  .select('*, users!inner(role)')
  .eq('users.role', 'monitor');

for (const sub of subscriptions) {
  await sendPushNotification(sub, {
    title: '新しいアンケート📝',
    body: '「就活に関するアンケート」に回答して30ptゲット！',
    icon: '/icon-192x192.png',
    data: { url: '/surveys/123' },
    actions: [
      { action: 'view', title: '回答する' }
    ]
  });
}
```

### 6.3 アンケート監視（v2.0更新）

#### 6.3.1 回答状況モニタリング
**リアルタイム監視**:
- 回答数の推移
- 回答率（目標: 60%以上）
- 回答完了率（途中離脱率）
- 所要時間の平均

**異常検知**:
- 極端に短い回答時間（ボット疑い）
- 同一パターンの回答連続
- 不自然な自由記述（スパム）
- **同一IPからの大量回答** 🆕

---

## 7. ポイント交換運用 🆕（v2.0: 自動化）

### 7.1 自動交換フロー

#### 7.1.1 通常フロー（自動）
```
1. ユーザーがポイント交換申請（PointExchangeModal）
   ↓
2. システムが申請を受付（pending状態で保存）
   ↓
3. **外部ポイント交換APIに自動連携** 🆕
   ├─ APIキー認証
   ├─ 署名生成（HMAC-SHA256）
   └─ POST /api/v1/exchange/request
   ↓
4. 交換URL/コードを取得
   ↓
5. データベース更新（completed状態）
   ↓
6. **自動通知送信**
   ├─ LINE連携ユーザー → LINE通知
   └─ 未連携ユーザー → メール通知
   ↓
7. ポイント減算
   ↓
8. 完了
```

#### 7.1.2 エラー時のフォールバック
```
外部API呼び出し失敗
   ↓
リトライ（最大3回、指数バックオフ）
   ↓
全て失敗
   ↓
**手動承認モードに切り替え** 🆕
   ↓
管理者に通知（Slack/メール）
   ↓
管理者が PointExchangeManager で手動承認
```

### 7.2 手動承認フロー（フォールバック）

#### 7.2.1 手動承認画面（PointExchangeManager.tsx）
**表示内容**:
- 申請ID
- ユーザー情報
- ポイント数
- 交換先
- 通知方法（LINE/メール）
- ステータス

**操作**:
1. ギフト券URL/コードを手動入力
2. 「承認 & 送信」ボタンをクリック
3. 自動で通知送信
4. ポイント減算

### 7.3 運用監視

#### 7.3.1 日次チェック
- [ ] 保留中の申請数を確認
- [ ] 外部APIのエラー率を確認
- [ ] 交換完了率を確認（目標: 95%以上）
- [ ] ユーザーからの問い合わせを確認

#### 7.3.2 月次レビュー
- 総交換件数
- 外部API別の成功率
- 平均処理時間
- コスト分析

---

## 8. 友達紹介運用 🆕

### 8.1 紹介コード管理

#### 8.1.1 コード発行
**自動発行**:
- ユーザーが「友達を招待」ボタンをクリック
- システムがユニークなコードを生成（`KOECAN-XXXXXXXX`）
- データベースに保存

**コード形式**:
- プレフィックス: `KOECAN-`
- ランダム英数字: 8桁
- 重複チェック: 自動

### 8.2 不正利用の監視と対応

#### 8.2.1 自動検知ルール
**検知条件**:
```sql
-- 同一IPから1時間以内に5件以上の新規登録
SELECT ip_address, COUNT(*) as reg_count
FROM users
WHERE created_at > NOW() - INTERVAL '1 hour'
GROUP BY ip_address
HAVING COUNT(*) >= 5;

-- 同一紹介コードで1日に10件以上の成功
SELECT referral_code_id, COUNT(*) as success_count
FROM referral_history
WHERE created_at > NOW() - INTERVAL '1 day'
GROUP BY referral_code_id
HAVING COUNT(*) >= 10;
```

**自動対応**:
1. 該当ユーザーに「審査中」フラグを立てる
2. ポイント付与を一時停止
3. カスタマーサポートに通知

#### 8.2.2 手動審査フロー
```
1. カスタマーサポートが通知を受信
   ↓
2. 登録パターンを調査
   ├─ IPアドレス履歴
   ├─ User Agent
   ├─ 登録時刻
   └─ その他の行動パターン
   ↓
3. 判定
   ├─ 正常 → ポイント付与、フラグ解除
   └─ 不正 → アカウント停止、ポイント取り消し
   ↓
4. ユーザーに通知
```

### 8.3 キャンペーン運用

#### 8.3.1 紹介ボーナスキャンペーン
**例**: 期間限定で紹介報酬を2倍に

**設定方法**:
```sql
-- システム設定テーブルを更新
UPDATE system_settings 
SET value = '400' 
WHERE key = 'referral_reward_points';

-- 期間を設定
UPDATE system_settings 
SET value = '2025-12-01' 
WHERE key = 'campaign_start_date';

UPDATE system_settings 
SET value = '2025-12-31' 
WHERE key = 'campaign_end_date';
```

**告知**:
- お知らせバナーで告知
- LINE/プッシュ通知で告知
- ダッシュボードに特別表示

---

## 9. FAQ・お知らせ運用 🆕

### 9.1 FAQ運用

#### 9.1.1 FAQ作成・更新フロー
```
1. ユーザーからの問い合わせ分析
   ├─ よくある質問をピックアップ
   └─ 問い合わせ頻度の高い内容を特定
   ↓
2. FAQ下書き作成
   ├─ 質問文を明確に
   ├─ 回答文をわかりやすく（Markdown）
   └─ カテゴリを選択
   ↓
3. レビュー
   ├─ カスタマーサポートが確認
   └─ 必要に応じて修正
   ↓
4. 公開
   ↓
5. 効果測定
   ├─ FAQ閲覧数
   └─ 問い合わせ減少率
```

#### 9.1.2 FAQ更新サイクル
- **定期レビュー**: 月次
- **緊急更新**: 新機能リリース時、仕様変更時
- **季節対応**: 就活時期など

#### 9.1.3 FAQ品質管理
**チェック項目**:
- [ ] 質問が明確か
- [ ] 回答が網羅的か
- [ ] 手順が具体的か
- [ ] スクリーンショットが必要か
- [ ] リンクが正しいか

### 9.2 お知らせ運用

#### 9.2.1 お知らせ作成フロー
```
1. お知らせ内容の決定
   ├─ 新機能リリース
   ├─ メンテナンス予定
   ├─ キャンペーン告知
   └─ 重要なお知らせ
   ↓
2. お知らせ下書き作成（AdminDashboard）
   ├─ タイトル
   ├─ 本文（Markdown）
   ├─ お知らせタイプ
   ├─ 公開期間
   ├─ 対象ユーザー（Monitor/Client/All）
   └─ プッシュ通知の有無
   ↓
3. レビュー・承認
   ↓
4. 予約公開 or 即時公開
   ↓
5. プッシュ通知送信（オプション）
   ├─ LINE連携ユーザー
   ├─ ブラウザプッシュ購読者
   └─ メール（重要な場合のみ）
```

#### 9.2.2 お知らせの種類と運用

| 種類 | 頻度 | プッシュ通知 | 例 |
|------|------|-------------|-----|
| 新機能リリース | 月1-2回 | あり | 友達紹介機能リリース |
| メンテナンス | 月1回 | あり | 定期メンテナンス予定 |
| キャンペーン | 不定期 | あり | 紹介ボーナス2倍キャンペーン |
| 重要なお知らせ | 随時 | あり | 利用規約改定 |
| 一般のお知らせ | 随時 | なし | ブログ更新 |

#### 9.2.3 お知らせ表示ルール
**バナー表示**:
- 優先度「高」のお知らせを最大2件
- ユーザーが「×」で閉じるまで表示
- Cookie/LocalStorageで非表示状態を記録

**一覧表示**:
- 時系列順（新しい順）
- 未読バッジ表示
- カテゴリ別フィルタ

---

## 10. 通知運用 🆕

### 10.1 通知チャネルの優先順位

#### 10.1.1 チャネル選択ルール
```
通知送信判定
   ↓
LINE連携済み？
├─ Yes → LINE通知送信
└─ No ↓
   ブラウザプッシュ許可済み？
   ├─ Yes → プッシュ通知送信
   └─ No ↓
      メール通知送信（フォールバック）
```

#### 10.1.2 通知タイプ別の配信方法

| 通知タイプ | LINE | プッシュ | メール |
|-----------|------|---------|--------|
| 新規アンケート | ✅ | ✅ | ❌ |
| ポイント付与 | ✅ | ✅ | ❌ |
| ポイント交換完了 | ✅ | ✅ | ✅ |
| 友達紹介成功 | ✅ | ✅ | ❌ |
| キャンペーン告知 | ✅ | ✅ | ❌ |
| メンテナンス予定 | ✅ | ✅ | ✅ |
| 重要なお知らせ | ✅ | ✅ | ✅ |

### 10.2 LINE通知運用

#### 10.2.1 LINE公式アカウント管理
**月間メッセージ上限**:
- フリープラン: 1,000通/月
- ライトプラン: 15,000通/月
- スタンダードプラン: 45,000通/月

**上限管理**:
```sql
-- 月間送信数の確認
SELECT COUNT(*) FROM line_messages 
WHERE sent_at >= DATE_TRUNC('month', NOW());

-- 上限接近アラート（80%）
CREATE OR REPLACE FUNCTION check_line_message_limit()
RETURNS void AS $$
DECLARE
  monthly_count INTEGER;
  monthly_limit INTEGER := 15000; -- ライトプラン
BEGIN
  SELECT COUNT(*) INTO monthly_count 
  FROM line_messages 
  WHERE sent_at >= DATE_TRUNC('month', NOW());
  
  IF monthly_count > monthly_limit * 0.8 THEN
    -- Slack通知
    PERFORM send_slack_notification('LINE月間送信数が80%を超えました');
  END IF;
END;
$$ LANGUAGE plpgsql;
```

**上限超過時の対応**:
1. 重要度の低い通知を停止（新規アンケートなど）
2. プッシュ通知またはメールで代替
3. プランアップグレードを検討

#### 10.2.2 LINE連携サポート
**ユーザーからの問い合わせ対応**:
- 「LINE連携できない」→ ブラウザ、OS確認、手順案内
- 「通知が来ない」→ 公式アカウントのブロック確認、通知設定確認
- 「連携解除したい」→ マイページから解除可能を案内

### 10.3 ブラウザプッシュ通知運用

#### 10.3.1 購読管理
**許可率の向上施策**:
- 初回ログイン後に自然なタイミングで許可リクエスト
- 「新しいアンケートをいち早く知るために通知を許可してください」
- 許可のメリットを明確に説明

**購読解除の対応**:
- マイページで簡単に解除可能
- 解除後もLINEやメールで通知継続

#### 10.3.2 プッシュ通知のベストプラクティス
**送信頻度**:
- 1日最大3件まで
- 重要度の高いものを優先

**メッセージ内容**:
- タイトル: 20文字以内
- 本文: 50文字以内
- アクションボタン: 明確に

**送信タイミング**:
- 避けるべき時間: 深夜（23:00-7:00）
- 推奨時間: 朝（7:00-9:00）、昼（12:00-13:00）、夕方（18:00-20:00）

### 10.4 メール通知運用

#### 10.4.1 送信元設定
- **From**: noreply@koekyan.example.com
- **Reply-To**: support@koekyan.example.com
- **DKIM/SPF**: 設定必須（なりすまし防止）

#### 10.4.2 配信管理
**バウンス処理**:
```typescript
// SendGrid Webhook で受信
app.post('/webhook/sendgrid', async (req, res) => {
  const events = req.body;
  
  for (const event of events) {
    if (event.event === 'bounce' || event.event === 'dropped') {
      // ユーザーのメールアドレスを無効化
      await supabase
        .from('users')
        .update({ email_invalid: true })
        .eq('email', event.email);
    }
  }
  
  res.sendStatus(200);
});
```

**配信停止（Opt-out）**:
- メール本文に「配信停止」リンクを必ず含める
- ワンクリックで配信停止可能
- 重要な通知（ポイント交換完了等）は配信停止対象外

---

## 11. ユーザーサポート

### 11.1 問い合わせ対応（v2.0更新）

#### 11.1.1 問い合わせチャネル
**メール**
- アドレス: support@koekyan.example.com
- 対応時間: 平日10:00-18:00
- 目標返信時間: 24時間以内

**アプリ内問い合わせフォーム**
- カテゴリ選択式
- スクリーンショット添付可能
- 自動チケット発行

**チャット**（ChatModal.tsx） 🆕
- リアルタイムサポート
- 平日10:00-18:00（サポート担当者がオンライン時）
- 対応中のモニター一覧（SupportDashboard）

**FAQ**（セルフサービス） 🆕
- 24時間利用可能
- よくある質問50件以上
- 検索機能

#### 11.1.2 問い合わせ分類（v2.0更新）
| カテゴリ | 優先度 | 目標対応時間 |
|----------|--------|--------------|
| ログインできない | 高 | 4時間以内 |
| ポイントが付与されない | 高 | 8時間以内 |
| ポイント交換について | 中 | 1営業日以内 |
| 友達紹介について 🆕 | 中 | 1営業日以内 |
| LINE連携について 🆕 | 中 | 1営業日以内 |
| アンケートの内容について | 中 | 1営業日以内 |
| その他 | 低 | 2営業日以内 |

#### 11.1.3 チャットサポート運用 🆕
**対応フロー**:
```
1. モニターがチャットボタンをクリック
   ↓
2. サポート担当者の SupportDashboard に通知
   ↓
3. サポート担当者が対応開始
   ↓
4. リアルタイムでメッセージ交換
   ↓
5. 解決確認
   ↓
6. チャット終了
   ↓
7. 満足度調査（オプション）
```

**定型文の活用**:
```typescript
// よくある質問への定型返信
const quickReplies = {
  'password_reset': 'パスワードリセットは、ログイン画面の「パスワードを忘れた方」からお手続きください。',
  'point_delay': 'ポイント付与は通常、アンケート回答後すぐに反映されます。反映されない場合は...',
  'referral_code': '友達紹介コードは、マイページの「友達を招待」から発行できます。',
};
```

### 11.2 FAQ管理（v2.0: 詳細化）

#### 11.2.1 初期FAQリスト（50件）
**アカウント・登録**（10件）:
1. 会員登録の方法は？
2. ログインできません
3. パスワードを忘れました
4. メールアドレスを変更したい
5. 退会方法は？
6. 登録確認メールが届きません
7. パスワードの設定ルールは？
8. 複数アカウントは作れますか？
9. アカウント情報を変更したい
10. プロフィール情報は公開されますか？

**アンケート**（15件）:
1. アンケートの回答方法は？
2. 回答を修正できますか？
3. アンケートが表示されません
4. 回答期限を過ぎたらどうなりますか？
5. どのくらいのアンケートがありますか？
6. プロフィールアンケートとは？
7. 途中まで回答して保存できますか？
8. アンケート回答にかかる時間は？
9. 自分に合ったアンケートを見つけるには？
10. アンケートの種類は？
11. アンケート回答後、ポイントがもらえないことは？
12. 企業は私の回答を見られますか？
13. アンケート結果はどう使われますか？
14. 不適切なアンケートを報告したい
15. アンケート通知の設定方法は？

**ポイント**（15件）:
1. ポイントの貯め方は？
2. ポイントが付与されません
3. ポイント交換の方法は？
4. 最低交換ポイント数は？
5. ポイントに有効期限はありますか？
6. 1ポイントはいくらですか？
7. ポイント履歴の確認方法は？
8. 交換したポイントはいつ届きますか？
9. ポイント交換できる先は？
10. ポイント交換の手数料は？
11. ポイントが減っている理由は？
12. ポイント交換をキャンセルしたい
13. 複数回に分けてポイント交換できますか？
14. ポイントを家族に譲れますか？
15. ポイント交換の上限はありますか？

**友達紹介**（5件） 🆕:
1. 紹介コードの発行方法は？
2. 紹介特典はいつもらえますか？
3. 紹介が反映されません
4. 紹介できる人数に制限はありますか？
5. 自分で紹介コードを使えますか？

**その他**（5件）:
1. お問い合わせ方法は？
2. プライバシーポリシーについて
3. 利用規約について
4. LINE連携の方法は？ 🆕
5. プッシュ通知の設定方法は？ 🆕

#### 11.2.2 FAQ更新運用
**更新トリガー**:
- 新機能リリース時
- 問い合わせが3件以上来た内容
- 仕様変更時
- ユーザーフィードバック

**更新フロー**:
1. カスタマーサポートがFAQ候補を提案
2. コンテンツ管理者がFAQ作成
3. レビュー
4. 公開
5. お知らせで告知（重要な場合）

---

## 12. データ管理

### 12.1 データライフサイクル（v2.0更新）

#### 12.1.1 データ収集
**収集時の原則**:
- 必要最小限のデータのみ収集
- 収集目的の明示
- ユーザーの同意取得（利用規約・プライバシーポリシー）

**データ品質管理**:
- 入力値検証（バリデーション）
- データ型の統一
- 重複データの排除

#### 12.1.2 データ保管
**Supabaseストレージ**:
- Database: ホットデータ（頻繁にアクセス）
- Storage: ファイル（画像、添付ファイル）
- 暗号化: Supabase標準の暗号化

**データ分類**:
| 分類 | 例 | 保持期間 | アクセス制限 |
|------|-----|----------|--------------|
| 機密情報 | パスワード、個人情報 | 法定期間 | RLSポリシー厳格 |
| 重要情報 | アンケート回答、ポイント履歴 | 無期限 | RLSポリシー制限 |
| 一般情報 | お知らせ、FAQ | 公開終了後1年 | 公開 |
| ログデータ | アクセスログ | 90日 | 管理者のみ |

#### 12.1.3 データアーカイブ
**アーカイブ対象**:
- 1年以上前の古いアンケート回答
- 退会ユーザーのデータ（匿名化後）
- 過去のログデータ

**アーカイブ方法**（Supabase）:
```sql
-- 古いデータを別テーブルに移動
CREATE TABLE survey_responses_archive (LIKE survey_responses);

INSERT INTO survey_responses_archive 
SELECT * FROM survey_responses 
WHERE created_at < NOW() - INTERVAL '1 year';

DELETE FROM survey_responses 
WHERE created_at < NOW() - INTERVAL '1 year';
```

#### 12.1.4 データ削除（v2.0更新）
**削除対象**:
- ユーザー退会後1年経過したデータ
- 保持期間を過ぎたログ
- テストデータ
- **不正利用が確定したユーザーのデータ** 🆕

**削除方法**:
- 論理削除（deleted_atフラグ）→ 一定期間後に物理削除
- 完全削除（復元不可能な方法）
- 削除ログの記録

---

## 13. リリース管理

### 13.1 リリースプロセス（v2.0更新）

#### 13.1.1 リリース種別
**定期リリース**
- 頻度: 月2回（第1・第3火曜日）
- 内容: 新機能、改善、バグ修正

**緊急リリース**
- 頻度: 必要時
- 内容: 重大なバグ修正、セキュリティパッチ

**ホットフィックス**
- 頻度: 緊急時
- 内容: 致命的な障害の即時修正

#### 13.1.2 リリース前チェックリスト（v2.0更新）
- [ ] コードレビュー完了
- [ ] 単体テスト完了（カバレッジ80%以上）
- [ ] 統合テスト完了
- [ ] **RLSポリシーの確認** 🆕
- [ ] **外部API連携のテスト** 🆕
- [ ] **通知機能のテスト（LINE/プッシュ/メール）** 🆕
- [ ] ステージング環境での動作確認
- [ ] データベースマイグレーション計画
- [ ] ロールバック手順の確認
- [ ] リリースノート作成
- [ ] 関係者への事前通知
- [ ] Supabaseバックアップ取得完了

#### 13.1.3 リリース手順（v2.0: Vercel + Supabase）
```bash
# 1. Gitタグ作成
git tag -a v2.0.0 -m "Release v2.0.0: 友達紹介機能追加"
git push origin v2.0.0

# 2. Vercelへデプロイ
vercel --prod

# 3. Supabaseマイグレーション実行
supabase db push

# 4. 動作確認
# - トップページアクセス
# - ログイン確認
# - 新機能の動作確認

# 5. モニタリング開始
# - Sentryでエラー監視
# - Supabase Dashboardで負荷監視

# 6. リリース通知
# - お知らせ投稿
# - LINE/プッシュ通知（重要な機能の場合）
```

### 13.2 ロールバック（v2.0更新）

#### 13.2.1 ロールバック判断基準
- 致命的なバグの発見
- データ不整合の発生
- パフォーマンス大幅低下
- セキュリティ上の問題
- **外部API連携の重大な障害** 🆕

#### 13.2.2 ロールバック手順（Vercel）
```bash
# Vercelで前のデプロイメントにロールバック
vercel rollback

# データベースは手動ロールバック（必要に応じて）
supabase db reset --db-url $DATABASE_URL
```

---

## 14. パフォーマンス管理

### 14.1 パフォーマンス目標（v2.0更新）

#### 14.1.1 レスポンスタイム目標
| 機能 | 目標 | 許容上限 |
|------|------|----------|
| ページ読み込み | 1秒以内 | 3秒 |
| アンケート一覧表示 | 0.5秒以内 | 2秒 |
| アンケート回答送信 | 1秒以内 | 3秒 |
| ポイント交換処理 | 2秒以内 | 5秒 |
| **友達紹介コード発行** 🆕 | 0.5秒以内 | 2秒 |
| **LINE/プッシュ通知送信** 🆕 | 3秒以内 | 10秒 |
| ログイン | 0.5秒以内 | 2秒 |

#### 14.1.2 Supabaseパフォーマンス目標
- **データベースクエリ**: 100ms以内
- **API レスポンス**: 500ms以内
- **Realtime遅延**: 1秒以内

### 14.2 パフォーマンス監視（v2.0: Supabase準拠）

#### 14.2.1 監視指標
**Supabase Dashboard**:
- Database CPU使用率
- Database メモリ使用率
- API リクエスト数
- Database接続数
- スロークエリ

**フロントエンド（Sentry Performance）**:
- ページロード時間
- First Contentful Paint (FCP)
- Largest Contentful Paint (LCP)
- Time to Interactive (TTI)

### 14.3 パフォーマンスチューニング（v2.0更新）

#### 14.3.1 データベース最適化
**インデックス作成**:
```sql
-- よく検索されるカラムにインデックス
CREATE INDEX idx_surveys_status ON surveys(status);
CREATE INDEX idx_survey_responses_user_id ON survey_responses(user_id);
CREATE INDEX idx_point_history_user_id ON point_history(user_id);
CREATE INDEX idx_referral_history_referrer ON referral_history(referrer_user_id);
```

**クエリ最適化**:
```sql
-- スロークエリの特定
SELECT query, mean_exec_time, calls 
FROM pg_stat_statements 
ORDER BY mean_exec_time DESC 
LIMIT 10;
```

#### 14.3.2 フロントエンド最適化 🆕
**コード分割（Next.js）**:
```typescript
// 動的インポートでバンドルサイズ削減
const MatchingFeature = dynamic(() => import('@/components/MatchingFeature'), {
  loading: () => <Loader />,
  ssr: false
});
```

**画像最適化**:
```typescript
// Next.js Image コンポーネント
import Image from 'next/image';

<Image 
  src="/logo.png" 
  width={200} 
  height={100} 
  alt="Logo"
  priority // Above the fold
/>
```

---

## 15. コスト管理

### 15.1 コスト項目（v2.0更新）

#### 15.1.1 Supabaseコスト
**プラン**: Pro プラン推奨
- **月額**: $25/月
- **含まれるもの**:
  - 8GB Database
  - 100GB Bandwidth
  - 100GB Storage
  - 日次バックアップ（7日間保持）
  - Point-in-Time Recovery

**超過料金**:
- Database: $0.125/GB/月
- Bandwidth: $0.09/GB
- Storage: $0.021/GB/月

#### 15.1.2 外部サービスコスト 🆕
| サービス | プラン | 月額想定 |
|---------|--------|----------|
| **ポイント交換API** | 従量課金 | ¥5,000-20,000 |
| **LINE Messaging API** | ライトプラン | ¥5,000 |
| **SendGrid（メール）** | Essentials | $20-50 |
| **Sentry** | Developer | $26 |
| **Vercel** | Pro | $20 |
| **ドメイン・SSL** | - | $10 |
| **合計** | - | **$91-146 + ¥10,000-25,000** |

#### 15.1.3 予想月額コスト（500ユーザー時）
- Supabase: $25-50
- 外部サービス: $70-100
- ポイント交換API: ¥10,000-20,000
- LINE API: ¥5,000
- **合計**: **約$100-150 + ¥15,000-25,000**（約¥30,000-45,000）

### 15.2 コスト最適化（v2.0更新）

#### 15.2.1 定期レビュー
**頻度**: 月次

**確認項目**:
- Supabaseの使用量（Database、Bandwidth、Storage）
- 外部APIの使用量
- 不要なリソースの削除
- **LINE月間メッセージ数の管理** 🆕
- **プッシュ通知送信数の管理** 🆕

#### 15.2.2 コスト削減施策
**Supabase**:
- 古いデータのアーカイブ（Database容量削減）
- 画像の圧縮（Storage容量削減）
- CDN活用（Bandwidth削減）

**LINE API** 🆕:
- 重要度の低い通知はプッシュ通知で代替
- 月間上限に近づいたら配信を絞る

**メール送信**:
- バウンスメールの削除（送信先クリーンアップ）
- テンプレートの最適化

---

## 16. 定期メンテナンス

### 16.1 メンテナンス計画（v2.0更新）

#### 16.1.1 定期メンテナンス
**頻度**: 月1回（第2火曜日 3:00-5:00）

**作業内容**:
- Supabase統計情報の更新
- データベース最適化（VACUUM）
- ログローテーション
- 不要データの削除
- バックアップの検証
- **RLSポリシーの確認** 🆕
- **外部API接続テスト** 🆕

#### 16.1.2 メンテナンス通知 🆕
**3日前**:
- お知らせバナーで告知
- LINE/プッシュ通知で告知

**1日前**:
- 再度お知らせ

**当日**:
- メンテナンスモードON
- メンテナンス画面表示

#### 16.1.3 メンテナンス後確認
- [ ] 動作確認レポート作成
- [ ] ユーザーへの完了通知
- [ ] 問題発生時の対応記録
- [ ] **外部API連携の正常性確認** 🆕
- [ ] **通知機能の動作確認** 🆕

### 16.2 年次メンテナンス

**実施時期**: 年1回（年末年始またはGW）

**作業内容**:
- データベースの大規模最適化
- 不要データの大規模削除
- アーカイブデータの整理
- セキュリティ診断結果の反映
- ディザスタリカバリ訓練
- **外部API契約の見直し** 🆕
- **通知配信戦略の見直し** 🆕

---

## 17. 改善サイクル（v2.0更新）

### 17.1 PDCAサイクル

#### 17.1.1 Plan（計画）
- KPI目標の設定
- 改善施策の立案
- 優先順位付け
- **新機能の企画（友達紹介キャンペーン等）** 🆕

#### 17.1.2 Do（実行）
- 施策の実施
- データ収集

#### 17.1.3 Check（評価）
- KPIの測定
- 効果検証
- 課題の抽出
- **友達紹介の効果測定** 🆕
- **通知配信の効果測定** 🆕

#### 17.1.4 Act（改善）
- 成功施策の横展開
- 失敗原因の分析
- 次回施策への反映

### 17.2 定期レビュー会議（v2.0更新）

#### 17.2.1 週次レビュー
- 参加者: 運用チーム全員
- 内容: 
  - 先週の障害・問題報告
  - KPIの確認
  - **友達紹介の状況** 🆕
  - **通知配信の状況** 🆕
  - 今週の予定

#### 17.2.2 月次レビュー
- 参加者: 運用チーム + 経営層
- 内容:
  - 月次KPIレビュー
  - 主要な改善施策の報告
  - **友達紹介キャンペーンの結果** 🆕
  - **FAQ・お知らせの効果** 🆕
  - 次月の計画

#### 17.2.3 四半期レビュー
- 参加者: 全ステークホルダー
- 内容:
  - 四半期目標の達成状況
  - 大型施策の振り返り
  - **外部API連携の見直し** 🆕
  - 次四半期の戦略

---

**文書作成日**: 2025年11月22日  
**バージョン**: 2.0  
**作成者**: Claude  
**承認者**: （承認予定）  
**次回レビュー予定**: v2.0機能リリース後